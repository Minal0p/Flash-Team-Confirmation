<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مشروع تخرج فريق Flash - متكامل مع Supabase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Cairo', sans-serif;
            overflow-x: hidden;
            padding-top: 70px; /* Navbar height */
            background-color: #121212; /* Dark background inspired by Wired */
            color: #e0e0e0; /* Light text for dark background */
            position: relative; 
            z-index: 1; 
        }
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .navbar {
            background-color: rgba(20, 20, 20, 0.85); 
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            position: fixed;
            top: 0;
            right: 0;
            left: 0;
            z-index: 1030;
            padding: 0.75rem 1.5rem;
            animation: fadeIn 1s ease-out;
        }
        .navbar-brand {
            font-size: 2rem; 
            font-weight: 900; 
            color: #00aaff; 
            letter-spacing: -1px;
        }
        .nav-link, .auth-link {
            color: #cccccc;
            font-weight: 600;
            padding: 0.6rem 1.2rem;
            transition: color 0.3s ease, background-color 0.3s ease;
            border-radius: 6px;
            text-transform: uppercase; 
            font-size: 0.85rem;
            letter-spacing: 0.5px;
            cursor: pointer;
        }
        .nav-link:hover, .nav-link.active, .auth-link:hover {
            color: #ffffff;
            background-color: rgba(0, 170, 255, 0.2); 
        }
        .navbar-toggler {
            border: none; font-size: 1.75rem; color: #00aaff;
        }

        .hero-section {
            position: relative;
            overflow: visible; 
            padding: 6rem 0; 
        }
        #heroCanvas {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100vw; 
            height: 100vh;
            z-index: -1; 
            opacity: 0.4; 
        }
        .hero-content {
            position: relative; z-index: 2; 
            animation: slideInUp 1s ease-out;
        }
        .hero-content h1 {
            font-size: 3.5rem; 
            font-weight: 900; 
            letter-spacing: -2px; 
            line-height: 1.1;
            color: #ffffff;
        }
        .hero-content .highlight {
            color: #00f0ff; 
        }
        .hero-content p {
            font-size: 1.25rem;
            color: #b0b0b0; 
            max-width: 700px;
            margin: 1.5rem auto 0;
        }
        .hero-content img.team-logo { 
            border-width: 4px; 
            border-color: rgba(0, 240, 255, 0.6); 
            background-color: rgba(255,255,255,0.1); 
        }

        .section-title {
            font-size: 2.5rem; 
            font-weight: 700;
            color: #ffffff; 
            border-bottom: 4px solid #00aaff;
            padding-bottom: 1rem;
            margin-bottom: 3rem; 
            text-align: center;
            animation: slideInUp 0.8s ease-out;
        }

        .btn {
            transition: all 0.3s ease;
            border-radius: 4px; 
            font-weight: 700;
            padding: 0.8rem 1.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
            border: 2px solid transparent;
            cursor: pointer;
        }
        .btn-primary { background-color: #00aaff; color: #121212; border-color: #00aaff; }
        .btn-primary:hover { background-color: #0088cc; border-color: #0088cc; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,170,255,0.3); }
        
        .btn-secondary { background-color: transparent; color: #ffc107; border-color: #ffc107; }
        .btn-secondary:hover { background-color: rgba(255,193,7,0.1); color: #ffd54f; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255,193,7,0.2); }

        .btn-ai-feature { background-color: #9c27b0; color:white; border-color: #9c27b0;} 
        .btn-ai-feature:hover { background-color: #7b1fa2; border-color: #7b1fa2; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(156,39,176,0.3); }
        
        .btn-contact { background-color: #4caf50; color: white; border-color: #4caf50; } 
        .btn-contact:hover { background-color: #388e3c; border-color: #388e3c; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(76,175,80,0.3); }

        .btn-danger { background-color: #f44336; color: white; border-color: #f44336; }
        .btn-danger:hover { background-color: #d32f2f; border-color: #d32f2f; }

        .card-base {
            background-color: #1a1a1a; border: 1px solid #2a2a2a;
            border-radius: 8px; padding: 2rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            animation: slideInUp 0.6s ease-out;
            animation-delay: var(--animation-delay, 0s);
            opacity:0; animation-fill-mode: forwards;
        }
        .form-input, .form-textarea, .form-file-input {
            background-color: #2a2a2a; border: 1px solid #3a3a3a; color: #e0e0e0;
            border-radius: 4px; padding: 0.75rem; width: 100%; margin-bottom: 1rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .form-input:focus, .form-textarea:focus, .form-file-input:focus {
            outline: none; border-color: #00aaff; box-shadow: 0 0 0 3px rgba(0,170,255,0.2);
        }
        .form-input::placeholder, .form-textarea::placeholder { color: #777; }
        
        .form-file-input::-webkit-file-upload-button { 
            background-color: #00aaff; color: #121212; border: none;
            padding: 0.5rem 1rem; border-radius: 4px; margin-right: 1rem; 
            font-weight: 600; cursor: pointer; transition: background-color 0.3s ease;
        }
        .form-file-input::-webkit-file-upload-button:hover { background-color: #0088cc; }
        .form-file-input::file-selector-button { 
            background-color: #00aaff; color: #121212; border: none;
            padding: 0.5rem 1rem; border-radius: 4px; margin-inline-end: 1rem;
            font-weight: 600; cursor: pointer; transition: background-color 0.3s ease;
        }
        .form-file-input::file-selector-button:hover { background-color: #0088cc; }


        .idea-card, .event-card {
             background-color: #202020; border-left: 5px solid #00aaff; padding: 1.25rem;
        }
        .idea-card:hover, .event-card:hover {
            box-shadow: 0 10px 30px rgba(0,170,255,0.1); border-left-color: #00f0ff;
        }
        .event-card img.event-image-display { 
            max-width: 100%;
            height: auto;
            max-height: 250px; 
            object-fit: cover; 
            border-radius: 4px;
            margin-bottom: 0.75rem;
            border: 1px solid #333;
        }
        
        .team-member-card { background-color: #1e1e1e; border: 1px solid #333; }
        .team-member-card img { border-color: #00aaff; object-fit: cover; } 
        .team-member-card h3 { color: #ffffff; font-size: 0.75rem; line-height: 1.1; word-break: break-word; }
        .team-member-card p { color: #00f0ff; font-size: 0.65rem; }

        .team-photo-container { 
            margin-bottom: 2.5rem;
            text-align: center;
        }
        .team-photo-container img {
            max-width: 100%;
            max-height: 450px; 
            width: auto; 
            height: auto; 
            border-radius: 8px;
            border: 3px solid #00aaff;
            box-shadow: 0 5px 15px rgba(0,170,255,0.2);
            display: inline-block;
        }


        .technology-badge {
            background-color: #00aaff; color: #121212; font-weight: 700;
            padding: 0.6rem 1.2rem; border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,170,255,0.2);
        }
        .technology-badge:hover { background-color: #00f0ff; transform: scale(1.05); }

        .modal {
            display: none; 
            position: fixed; 
            z-index: 1050; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; 
            background-color: rgba(0,0,0,0.7); 
            animation: fadeIn 0.3s ease-out;
        }
        .modal-content { 
            background-color: #1e1e1e; 
            color: #e0e0e0; 
            border: 1px solid #333;
            margin: 10% auto; 
            padding: 25px; 
            border-radius: 8px;
            width: 90%; 
            max-width: 550px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            position: relative;
            animation: slideInUp 0.4s ease-out;
        }
        .modal-content h3 { color: #00aaff; }
        .close-button { 
            color: #aaa;
            float: left; 
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            left: 20px; 
            cursor: pointer;
        }
        .close-button:hover, .close-button:focus { color: #e0e0e0; text-decoration: none; }
        
        .loading-spinner {
            border: 4px solid #333; 
            border-top: 4px solid #00aaff; 
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #imageUploadProgress {
            width: 100%; background-color: #2a2a2a; border-radius: 4px;
            margin-top: 0.5rem; overflow: hidden; display: none; 
        }
        #imageUploadProgressBar {
            width: 0%; background-color: #00aaff; color: #121212;
            text-align: center; line-height: 1.25rem; height: 1.25rem;
            transition: width 0.4s ease;
        }


        .user-id-display { background-color: rgba(0,0,0,0.8); color: #00aaff; border: 1px solid #00aaff; padding: 5px 10px; border-radius:4px; font-size: 0.8rem; position:fixed; bottom:10px; left: 10px; z-index: 1000;}

        #authSection { 
            background-color: #222;
            border-top: 2px solid #00aaff;
        }
       
        footer { background-color: #0a0a0a; color: #888; padding: 3rem 1rem; }
        footer a { color: #00aaff; }
        footer a:hover { color: #00f0ff; }

        #profileModal .profile-avatar-container {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto 1.5rem auto;
        }
        #profileModal .profile-avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #00aaff;
        }
        #profileModal .avatar-upload-label {
            position: absolute;
            bottom: 0;
            right: 0;
            background-color: rgba(0, 170, 255, 0.8);
            color: white;
            padding: 0.3rem 0.5rem;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s;
        }
        #profileModal .avatar-upload-label:hover {
            background-color: rgba(0, 120, 200, 0.9);
        }
        #profileAvatarInput {
            display: none;
        }

        .comments-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #333;
        }
        .comment {
            background-color: #282828;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            margin-bottom: 0.75rem;
            border-left: 3px solid #0077cc;
        }
        .comment p { margin-bottom: 0.25rem; }
        .comment .commenter-name { font-weight: 600; color: #00aaff; }
        .comment .comment-date { font-size: 0.75rem; color: #888; }
        .comment-form input, .comment-form textarea {
             margin-bottom: 0.5rem;
        }
        
        .reaction-buttons {
            display: flex;
            gap: 0.3rem; 
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #33333350;
            flex-wrap: wrap; 
            justify-content: flex-start; 
        }
        .reaction-btn {
            background-color: #333;
            color: #ccc;
            border: 1px solid #444;
            padding: 0.2rem 0.5rem; 
            border-radius: 15px; 
            cursor: pointer;
            font-size: 0.7rem; 
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
        }
        .reaction-btn:hover {
            background-color: #444;
            border-color: #555;
            color: #fff;
        }
        .reaction-btn.active { 
            background-color: #00aaff;
            color: #121212;
            border-color: #00aaff;
        }
        .reaction-btn .emoji {
            margin-right: 0.2rem; 
            font-size: 0.9rem; 
        }
        .reaction-btn .count {
            font-size: 0.65rem; 
        }


        @media (max-width: 768px) {
            .hero-content h1 { font-size: 2.5rem; }
            .hero-content p { font-size: 1rem; }
            .section-title { font-size: 2rem; }
            .btn { padding: 0.7rem 1.2rem; font-size: 0.8rem; }
            .sm\:space-x-4 > :not([hidden]) ~ :not([hidden]) { margin-right: 0 !important; margin-left: 0 !important; }
            .sm\:space-x-4 button, .sm\:space-x-4 a.btn { width: 100%; margin-bottom: 0.75rem; }
            .navbar-nav {
                background-color: #141414; 
                border-radius: 8px; margin-top: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                padding: 0.5rem 0;
            }
             .nav-link, .auth-link { display: block; width: 100%; text-align: center; }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">
    <canvas id="heroCanvas"></canvas>

    <nav class="navbar navbar-expand-md">
        <div class="container mx-auto flex items-center justify-between px-4">
            <a class="navbar-brand" href="#"> <i class="fas fa-bolt mr-2"></i> فريق Flash</a>
            <button class="navbar-toggler md:hidden" type="button" onclick="toggleNavbar()">
                <i class="fas fa-bars"></i>
            </button>
            <div class="hidden md:flex md:items-center" id="navbarNav">
                <ul class="flex flex-col md:flex-row md:items-center list-none md:ml-auto mt-3 md:mt-0 md:space-x-1 md:space-x-reverse">
                    <li><a class="nav-link" href="#about">عن المشروع</a></li>
                    <li><a class="nav-link" href="#project-ideas">الأفكار</a></li>
                    <li><a class="nav-link" href="#events">الأحداث</a></li>
                    <li><a class="nav-link" href="#team">الفريق</a></li>
                    <li><a class="nav-link" href="#technologies">التقنيات</a></li>
                    <li><a class="nav-link" href="#contact">تواصل</a></li>
                    <li><a id="profileLink" class="auth-link" onclick="openProfileModal()" style="display:none;">ملفي الشخصي</a></li>
                    <li><a id="authLink" class="auth-link" onclick="handleAuthLinkClick()">تسجيل الدخول</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div id="infoModal" class="modal">
      <div class="modal-content">
        <span class="close-button" onclick="closeModal('infoModal')">&times;</span>
        <h3 id="modalTitle" class="text-2xl font-bold mb-6"></h3>
        <div id="modalLoading" class="loading-spinner" style="display: none;"></div>
        <div id="modalText" class="text-lg leading-relaxed"></div>
      </div>
    </div>

    <div id="authModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('authModal')">&times;</span>
            <h3 id="authModalTitle" class="text-2xl font-bold mb-6 text-center">تسجيل الدخول</h3>
            <div id="authError" class="text-red-400 mb-4 text-center" style="display: none;"></div>
            <input type="email" id="emailInput" placeholder="البريد الإلكتروني" class="form-input">
            <input type="password" id="passwordInput" placeholder="كلمة المرور" class="form-input">
            <input type="text" id="academicIdInput" placeholder="الرقم الأكاديمي (عند إنشاء حساب)" class="form-input" style="display:none;">
            <input type="text" id="referralCodeInput" placeholder="كود الإحالة (اختياري)" class="form-input" style="display:none;">


            <div id="authButtonsContainer" class="mt-4 space-y-3">
                 <button id="loginButton" onclick="handleSupabaseLogin()" class="btn btn-primary w-full">دخول</button>
                 <button id="signupButton" onclick="handleSupabaseSignup()" class="btn btn-secondary w-full">إنشاء حساب جديد</button>
            </div>
            <p class="text-center mt-4 text-sm">
                <a href="#" id="switchToSignup" class="text-00aaff hover:underline">ليس لديك حساب؟ أنشئ واحدًا</a>
                <a href="#" id="switchToLogin" class="text-00aaff hover:underline" style="display:none;">لديك حساب بالفعل؟ سجل الدخول</a>
            </p>
        </div>
    </div>

    <div id="profileModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('profileModal')">&times;</span>
            <h3 class="text-2xl font-bold mb-6 text-center text-00aaff">إدارة الملف الشخصي</h3>
            
            <div class="profile-avatar-container">
                <img id="profileAvatarPreview" src="https://placehold.co/120x120/2a2a2a/cccccc?text=👤&font=cairo" alt="الصورة الشخصية" class="profile-avatar">
                <label for="profileAvatarInput" class="avatar-upload-label">
                    <i class="fas fa-camera"></i>
                </label>
                <input type="file" id="profileAvatarInput" accept="image/*" onchange="previewProfileAvatar(event)">
            </div>
            <div id="profileAvatarUploadProgress" class="text-sm text-00f0ff mt-1 mb-3 text-center" style="display:none;"></div>


            <div class="mb-4">
                <label for="profileFullNameInput" class="block text-sm font-medium text-gray-300 mb-1">الاسم الكامل:</label>
                <input type="text" id="profileFullNameInput" placeholder="اسمك الكامل" class="form-input">
            </div>
            <div class="mb-4">
                <label for="profileAcademicIdInput" class="block text-sm font-medium text-gray-300 mb-1">الرقم الأكاديمي:</label>
                <input type="text" id="profileAcademicIdInput" placeholder="الرقم الأكاديمي" class="form-input">
            </div>
            <div class="mb-6" id="profileReferralCodeSection" style="display:none;">
                <label for="profileReferralCodeInput" class="block text-sm font-medium text-gray-300 mb-1">إضافة كود إحالة لترقية الصلاحيات:</label>
                <input type="text" id="profileReferralCodeInput" placeholder="أدخل كود الإحالة" class="form-input">
                <button onclick="submitReferralCode()" class="btn btn-secondary w-full mt-2 text-sm py-2">تطبيق كود الإحالة</button>
            </div>
            <div id="profileUpdateStatus" class="text-sm text-center mb-4" style="display:none;"></div>
            <button onclick="updateUserProfile()" class="btn btn-primary w-full">حفظ التغييرات</button>
        </div>
    </div>


    <div id="userIdDisplay" class="user-id-display" style="display: none;">
        المستخدم: <span id="currentUserDisplay"></span> (<span id="currentUserRole"></span>)
    </div>

    <header id="hero" class="hero-section text-white text-center">
        <div class="hero-content container mx-auto px-6">
            <img 
                src="https://scontent.fcai2-2.fna.fbcdn.net/v/t39.30808-1/494309535_122098633448856506_897280692111650141_n.jpg?stp=dst-jpg_s200x200_tt6&_nc_cat=111&ccb=1-7&_nc_sid=e99d92&_nc_ohc=Bz25boy6AoEQ7kNvwHvK5Bt&_nc_oc=Adm74NanuwpouikJmdMAKYTsNw1FZ5VopC-V0U5DmSU9_MZ6V9idT_3hXk4N3SNDeRQ&_nc_zt=24&_nc_ht=scontent.fcai2-2.fna&_nc_gid=5AL02Pb_UfveNX4KWmkw5g&oh=00_AfLNC_zZRQ_f07_aq7akNrfeK96dZl0CYNG8W5XIK5utPQ&oe=68393267" 
                alt="شعار فريق Flash" 
                class="team-logo mx-auto mb-10 rounded-full shadow-2xl w-44 h-44 md:w-52 md:h-52 object-cover"
                onerror="this.onerror=null; this.src='https://placehold.co/180x180/121212/00f0ff?text=⚡&font=cairo';"
            >
            <h1 class="mb-6">فريق <span class="highlight">Flash</span>: نحو مستقبل كهربي ذكي</h1>
            <p class="font-light">نبتكر حلولاً متقدمة في التوزيع الكهربي بدمج التيار الخفيف، الأتمتة، وقوة الذكاء الاصطناعي.</p>
        </div>
    </header>

    <main class="container mx-auto px-4 md:px-6 py-10 md:py-16 relative z-10"> <section id="about" class="card-base mb-16" style="--animation-delay: 0.1s;">
            <h2 class="section-title">نبذة عن المشروع</h2>
            <p id="projectDescription" class="text-lg md:text-xl leading-relaxed text-gray-300 mb-8 text-center max-w-3xl mx-auto">
                يهدف مشروعنا إلى إحداث ثورة في أنظمة التوزيع الكهربي التقليدية من خلال دمج أحدث التقنيات في مجالات التيار الخفيف، الأتمتة المتقدمة، وتطبيقات الذكاء الاصطناعي. نسعى لتصميم وتنفيذ نظام توزيع كهربي فائق الكفاءة، يتميز بالاستدامة، القدرة على التكيف، وتوفير حلول مبتكرة لإدارة الشبكات الكهربية الذكية لمستقبل أكثر إشراقًا.
            </p>
            <div class="mt-10 text-center space-y-4 sm:space-y-0 sm:space-x-4 sm:space-x-reverse flex flex-col sm:flex-row justify-center items-center">
                <button onclick="showStaticModal('أفكار للمشروع', 'سيتم عرض أفكار المشروع هنا قريبًا.')" class="btn btn-secondary">
                    <i class="fas fa-lightbulb mr-2"></i> أفكار للمشروع
                </button>
                 <button onclick="showStaticModal('وصف تقني مفصل', 'سيتم عرض الوصف التقني المفصل هنا قريبًا.')" class="btn btn-ai-feature">
                    <i class="fas fa-file-alt mr-2"></i> وصف تقني مفصل
                </button>
                <button onclick="showStaticModal('تفاصيل إضافية عن المشروع', 'سنقوم قريبًا بإضافة المزيد من التفاصيل التقنية، المخططات، وأهداف المشروع المرحلية. تابعونا!')" class="btn btn-primary">
                    <i class="fas fa-info-circle mr-2"></i> المزيد (قريباً)
                </button>
            </div>
        </section>

        <section id="project-ideas" class="card-base mb-16" style="--animation-delay: 0.2s;">
            <h2 class="section-title">💡 بنك أفكار المشروع</h2>
            <div class="idea-input-group mb-8 max-w-2xl mx-auto flex items-center space-x-2 space-x-reverse">
                <input type="text" id="newIdeaInput" placeholder="شارك بفكرة جديدة لتطوير المشروع..." class="form-input flex-grow p-3 focus:ring-2 focus:ring-00aaff focus:border-transparent outline-none text-base">
                <button id="saveIdeaButton" onclick="saveNewIdeaSupabase(event)" class="btn btn-primary py-3 px-6 text-base"> <i class="fas fa-plus-circle mr-2"></i> حفظ الفكرة
                </button>
            </div>
            <div id="ideasContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <p id="loadingIdeas" class="text-gray-400 col-span-full text-center text-lg">يتم تحميل الأفكار من Supabase...</p>
            </div>
        </section>

        <section id="authSection" class="card-base mb-16" style="--animation-delay: 0.28s;">
            <h2 class="section-title">تسجيل الدخول / إنشاء حساب</h2>
            <div id="authContent" class="max-w-md mx-auto text-center">
                <p id="authStatus" class="mb-4">أنت غير مسجل الدخول حاليًا.</p>
                <button id="mainAuthButton" onclick="handleAuthLinkClick()" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt mr-2"></i> تسجيل الدخول أو إنشاء حساب
                </button>
            </div>
             <div id="userProfileInfo" class="mt-6 max-w-md mx-auto text-center" style="display:none;">
                <h3 class="text-xl font-semibold text-00f0ff">ملف المستخدم</h3>
                <div class="profile-avatar-container mb-3"> <img id="profileInfoAvatar" src="https://placehold.co/100x100/1a1a1a/cccccc?text=👤&font=cairo" alt="الصورة الشخصية" class="profile-avatar">
                </div>
                <p>البريد الإلكتروني: <span id="userEmailProfile"></span></p>
                <p>الرقم الأكاديمي: <span id="userAcademicIdProfile"></span></p>
                <p>الدور: <span id="userRoleProfile"></span></p>
                <p>آخر تسجيل دخول: <span id="userLastSignInProfile"></span></p>
                <button onclick="openProfileModal()" class="btn btn-secondary mt-4 text-sm py-2">تعديل الملف الشخصي</button>
            </div>
        </section>

        <section id="events" class="card-base mb-16" style="--animation-delay: 0.25s;">
            <h2 class="section-title">الأحداث والمنشورات</h2>
            
            <div id="addEventFormContainer" class="mb-8 max-w-2xl mx-auto" style="display: none;">
                <h3 class="text-xl font-semibold text-gray-100 mb-4">إضافة حدث أو منشور جديد</h3>
                <input type="text" id="eventTitleInput" placeholder="عنوان الحدث/المنشور" class="form-input">
                <textarea id="eventDescriptionInput" placeholder="وصف الحدث/المنشور..." rows="4" class="form-textarea"></textarea>
                <input type="date" id="eventDateInput" class="form-input">
                <label for="eventImageFileInput" class="block mb-2 text-sm font-medium text-gray-300">رفع صورة للحدث (اختياري):</label>
                <input type="file" id="eventImageFileInput" accept="image/*" class="form-file-input">
                
                <div id="imageUploadProgress">
                    <div id="imageUploadProgressBar">0%</div>
                </div>

                <button id="saveEventButton" onclick="saveNewEvent(event)" class="btn btn-primary w-full mt-4"> <i class="fas fa-calendar-plus mr-2"></i> إضافة الحدث
                </button>
            </div>

            <div id="eventsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <p id="loadingEvents" class="text-gray-400 col-span-full text-center text-lg">يتم تحميل الأحداث من Supabase...</p>
            </div>
        </section>

        <section id="team" class="card-base mb-16" style="--animation-delay: 0.3s;">
            <h2 class="section-title">فريق العمل (15 عضوًا)</h2>
             <div class="team-photo-container">
                <img src="https://placehold.co/800x400/1a1a1a/00f0ff?text=صورة+الفريق+هنا&font=cairo" 
                     alt="صورة فريق Flash" 
                     id="mainTeamPhoto"
                     onerror="this.onerror=null; this.src='https://placehold.co/800x400/1a1a1a/cccccc?text=تعذر+تحميل+صورة+الفريق&font=cairo';"
                >
                <p class="text-sm text-gray-400 mt-2">سيتم تحديث هذه الصورة بصورة الفريق الفعلية.</p>
            </div>
            <div id="teamGrid" class="grid grid-cols-4 gap-x-2 gap-y-4"> 
                <script>
                    const teamMembers = [ 
                        { name: "مينا حنا فهيم", role: "مهندس كهرباء", imgUrl: "https://scontent.fcai2-2.fna.fbcdn.net/v/t39.30808-1/275961489_2101578886686838_1186952474551148362_n.jpg?stp=dst-jpg_s200x200_tt6&_nc_cat=101&ccb=1-7&_nc_sid=1d2534&_nc_ohc=Y7kffxkrcj4Q7kNvwGQ2c9J&_nc_oc=Adl1TKie-OM8LRAySw9Kpt56l5ENvuaQK3cxAmtB1tP_roES4P-V6x_HR0CBjm1-14Y&_nc_zt=24&_nc_ht=scontent.fcai2-2.fna&_nc_gid=pHJP0egHAyTKWUvPObSo6w&oh=00_AfKwnHCpmkNWhAOUhw7lc6KneShAyz4OxEp2QI_R776plA&oe=683C0047", imgInitial: "م.ح" }, 
                        { name: "مينا فليب لبيب", role: "مهندس كهرباء", imgUrl: "https://uzcrjhhvwgllsdsvftuj.supabase.co/storage/v1/object/public/personal-image//Mena%20Philip.jpg", imgInitial: "م.ف" },
                        { name: "عمر عبد الهادي رمادي", role: "مهندس كهرباء", imgUrl: "https://scontent.fcai2-2.fna.fbcdn.net/v/t39.30808-1/468183044_2437537159925313_2222471100263851883_n.jpg?stp=dst-jpg_s200x200_tt6&_nc_cat=101&ccb=1-7&_nc_sid=1d2534&_nc_ohc=_NE04TfgaSAQ7kNvwHlZOqE&_nc_oc=AdmEuKE-xDi72E7DMn2VlhE86dGz6QPhuaGX-cF6VYCRO5LgviwplYy7YPHMV_cA54I&_nc_zt=24&_nc_ht=scontent.fcai2-2.fna&_nc_gid=V_nxds_h945QJcca_5A0mg&oh=00_AfIUPqCVD1VlNI29y9JngIgC_nn2Val78Tog_2ksytAX3g&oe=683BF6C3", imgInitial: "ع.ع" }, 
                        { name: "محمد سيد محمد حسان", role: "مهندس كهرباء", imgUrl: "https://scontent.fcai2-2.fna.fbcdn.net/v/t39.30808-6/468897498_956460742997297_4252898402209943443_n.jpg?stp=dst-jpg_p526x296_tt6&_nc_cat=110&ccb=1-7&_nc_sid=a5f93a&_nc_ohc=6VYrD6NRkhQQ7kNvwEoWVsa&_nc_oc=Adkzd3txaXg7ZdnhdedeJ84u6-2RVg9xqzzBJ6_3Ejt554ZyypETAVlMzBhFHtVog5w&_nc_zt=23&_nc_ht=scontent.fcai2-2.fna&_nc_gid=LBGu68vI2kUFSxu_qnDw8A&oh=00_AfKYo5L-jDzHgXJcW0dufezUmquW9YMFs7eD7Nb7XNNw7w&oe=683BEE8B", imgInitial: "م.س" },
                        { name: "محمد محمود بربري", role: "مهندس كهرباء", imgUrl: "https://scontent.fcai2-2.fna.fbcdn.net/v/t39.30808-6/470165541_4094575017436722_4593658555281273385_n.jpg?_nc_cat=100&ccb=1-7&_nc_sid=a5f93a&_nc_ohc=VJQgz6RpGeoQ7kNvwEx496C&_nc_oc=AdkF6Cy3nZgJQO6yCEtJBEwsgi5tgoopzrxjgBcugYfq5bwJoggbEp7WGh3mw_eF5QU&_nc_zt=23&_nc_ht=scontent.fcai2-2.fna&_nc_gid=u0NjoM5BSF6XuW5o5ZfQYA&oh=00_AfJlJ55AuNqroATBFoS7HT6x3TpFkV8VR4WXUaBlpz7DTQ&oe=683BE7E3", imgInitial: "م.م" }, 
                        { name: "احمد طارق احمد محمد", role: "مهندس كهرباء", imgUrl: "https://scontent.fcai2-1.fna.fbcdn.net/v/t39.30808-1/353852201_1923806154628741_2807269224716755389_n.jpg?stp=dst-jpg_s200x200_tt6&_nc_cat=104&ccb=1-7&_nc_sid=e99d92&_nc_ohc=_p81SIRjRvQQ7kNvwGKpFIM&_nc_oc=Adkj_fnYuMhOzZamx0NWLaN6ru5j62Fa6-dO2zf4GBPNnNT4HeW_K1q6mhCEbIyfNJU&_nc_zt=24&_nc_ht=scontent.fcai2-1.fna&_nc_gid=OauDqwAwI9X3_yqSF9lPzA&oh=00_AfLrx3KYndYl9bx69zg_GofswJugj8K82hQHaT-ex5sggA&oe=683C0E6A", imgInitial: "أ.ط" },
                        { name: "شروق محمد فتحي", role: "مهندس كهرباء", imgInitial: "ش.م" }, 
                        { name: "فرحه محمد صلاح", role: "مهندس كهرباء", imgInitial: "ف.م" },
                        { name: "حسن السيد فواز", role: "مهندس كهرباء", imgInitial: "ح.ا" }, 
                        { name: "احمد اشرف سليمان", role: "مهندس كهرباء", imgUrl: "https://scontent.fcai2-2.fna.fbcdn.net/v/t39.30808-1/434145069_1816733895407191_5553289515299517712_n.jpg?stp=c0.0.960.960a_dst-jpg_s200x200_tt6&_nc_cat=101&ccb=1-7&_nc_sid=e99d92&_nc_ohc=jzAXyr42rJMQ7kNvwH6ZYjY&_nc_oc=AdnuHAhDs36kdx83KUdpVNnNArJmw73cb0c6nC8BkaUw-9L1m_Iy8JcsoPH57mL4AHs&_nc_zt=24&_nc_ht=scontent.fcai2-2.fna&_nc_gid=SYk55mlBXjwqw5QrzTtjeQ&oh=00_AfKvO4MqzZlEbGjM-P0uR03dm0GfNDXNYxr6-aq_Su7hRw&oe=683C00F8", imgInitial: "أ.أ" },
                        { name: "كريم احمد نور الدين", role: "مهندس كهرباء", imgUrl: "https://scontent.fcai2-1.fna.fbcdn.net/v/t39.30808-6/480593048_1175410563998992_2144503893709080693_n.jpg?_nc_cat=109&ccb=1-7&_nc_sid=a5f93a&_nc_ohc=9XnCUadAXZkQ7kNvwFumUC6&_nc_oc=AdleDMcz_uhUxDcfTERzjbeX_TzvzUJPMtGZ2qmlQ1qigXyovD7Ry5o7zAaTgnQrfsY&_nc_zt=23&_nc_ht=scontent.fcai2-1.fna&_nc_gid=2vxcBeiOL_eBs2BFIXY_mg&oh=00_AfL_DB8FW1hQIuZ1W1opaL3Z-C1Cu0_gKJPHBMedp2aNdQ&oe=683C09B8", imgInitial: "ك.أ" }
                    ];
                    const vacantSpots = 4; 
                    let memberHtml = '';
                    teamMembers.forEach((member, index) => {
                        const imgSrc = member.imgUrl ? member.imgUrl : `https://placehold.co/70x70/1a1a1a/00f0ff?text=${encodeURIComponent(member.imgInitial)}&font=cairo`;
                        const placeholderSrc = `https://placehold.co/70x70/1a1a1a/cccccc?text=${encodeURIComponent(member.imgInitial)}&font=cairo`;
                        memberHtml += `
                        <div class="team-member-card p-2 sm:p-3 rounded-lg text-center" style="--animation-delay: ${index * 0.05}s; opacity:0; animation: slideInUp 0.5s ease-out forwards;">
                            <img src="${imgSrc}" alt="صورة ${member.name}" class="w-14 h-14 sm:w-16 sm:h-16 rounded-full mx-auto mb-1 border-2 shadow-md object-cover" onerror="this.onerror=null; this.src='${placeholderSrc}';">
                            <h3 class="text-xs font-bold mb-0.5 leading-tight">${member.name}</h3>
                            <p class="font-semibold text-xxs text-00aaff" style="font-size: 0.6rem;">${member.role}</p>
                        </div>`;
                    });
                    for (let i = 0; i < vacantSpots; i++) {
                        memberHtml += `
                        <div class="team-member-card p-2 sm:p-3 rounded-lg text-center bg-gray-700 bg-opacity-20 border-gray-600" style="--animation-delay: ${(teamMembers.length + i) * 0.05}s; opacity:0; animation: slideInUp 0.5s ease-out forwards;">
                            <div>
                                <img src="https://placehold.co/70x70/333333/888888?text=؟${i+1}&font=cairo" alt="مكان شاغر ${i+1}" class="w-14 h-14 sm:w-16 sm:h-16 rounded-full mx-auto mb-1 border-2 border-gray-500 shadow-md">
                                <h3 class="text-xs font-bold text-gray-300 mb-0.5 leading-tight">مكان شاغر ${i+1}</h3>
                                <p class="text-gray-400 mb-1 text-xxs" style="font-size: 0.6rem;">انضم إلينا!</p>
                            </div>
                            <button onclick="showStaticModal('اقتراح مهام', 'ميزة اقتراح المهام غير متاحة حاليًا.')" class="btn btn-secondary text-xxs py-1 px-2 w-full mt-auto" style="font-size: 0.55rem; padding: 0.2rem 0.4rem;">
                               <i class="fas fa-info-circle mr-1"></i> تفاصيل
                            </button>
                        </div>`;
                    }
                    const teamGridElement = document.getElementById('teamGrid');
                    if (teamGridElement) {
                        teamGridElement.innerHTML = memberHtml;
                    } else if (document.currentScript) {
                         document.currentScript.parentNode.innerHTML = memberHtml;
                    } else {
                        console.error("Could not find the team grid container to inject team members.");
                    }
                </script>
            </div>
        </section>

        <section id="technologies" class="card-base mb-16" style="--animation-delay: 0.4s;">
            <h2 class="section-title">التقنيات الأساسية</h2>
            <div id="technologiesList" class="flex flex-wrap justify-center gap-3 md:gap-4">
                <script>
                    const initialTechnologies = [
                        "توزيع كهربي متقدم", "أنظمة تيار خفيف ذكية", "أتمتة وتحكم (PLC/SCADA)",
                        "ذكاء اصطناعي (AI/ML)", "إنترنت الأشياء (IoT)", "تحليل بيانات ضخمة", 
                        "Supabase (قاعدة بيانات، مصادقة، تخزين)"
                    ];
                    let techHtml = '';
                    initialTechnologies.forEach((tech, index) => {
                        techHtml += `<span class="technology-badge" style="--animation-delay: ${index * 0.05}s; opacity:0; animation: slideInUp 0.5s ease-out forwards;">${tech}</span>`;
                    });
                     const techListElement = document.getElementById('technologiesList');
                    if (techListElement) {
                        techListElement.innerHTML = techHtml;
                    } else if (document.currentScript) {
                         document.currentScript.parentNode.innerHTML = techHtml;
                    } else {
                        console.error("Could not find the technologies list container.");
                    }
                </script>
            </div>
            <div class="mt-10 text-center">
                <button onclick="showStaticModal('اقتراح تقنيات', 'ميزة اقتراح التقنيات الإضافية غير متاحة حاليًا.')" class="btn btn-ai-feature">
                    <i class="fas fa-cogs mr-2"></i> تقنيات إضافية (قريباً)
                </button>
            </div>
        </section>

        <section id="contact" class="card-base text-center" style="--animation-delay: 0.5s;">
            <h2 class="section-title">تواصل مع فريق Flash</h2>
            <p class="text-lg md:text-xl text-gray-300 mb-8 max-w-2xl mx-auto">
                نحن متحمسون لسماع آرائكم واقتراحاتكم! إذا كان لديكم أي استفسارات أو كنتم ترغبون في معرفة المزيد عن مشروعنا الطموح، فلا تترددوا في التواصل معنا.
            </p>
            <a href="mailto:minahanna@ieee.org?subject=استفسار%20بخصوص%20مشروع%20Flash&body=تحية%20لفريق%20Flash،%0D%0A%0D%0Aأود%20الاستفسار%20عن%20..." class="btn btn-contact text-lg inline-flex items-center">
                <i class="fas fa-envelope mr-3"></i> أرسل بريد إلكتروني
            </a>
        </section>
    </main>

    <footer class="text-center py-10 mt-16">
        <p class="text-lg mb-2">&copy; 2025 فريق Flash - جميع الحقوق محفوظة.</p>
        <p class="text-md">كلية الهندسة - قسم الهندسة الكهربية (مشروع تخرج)</p>
        <div class="mt-6 space-x-4 space-x-reverse">
             <a href="#" class="text-2xl hover:text-00f0ff transition-colors"><i class="fab fa-facebook-f"></i></a>
             <a href="#" class="text-2xl hover:text-00f0ff transition-colors"><i class="fab fa-linkedin-in"></i></a>
             <a href="#" class="text-2xl hover:text-00f0ff transition-colors"><i class="fab fa-github"></i></a>
        </div>
    </footer>

    <script type="module">
        // --- إعداد Supabase ---
        const SUPABASE_URL = 'https://uzcrjhhvwgllsdsvftuj.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV6Y3JqaGh2d2dsbHNkc3ZmdHVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgyMTcxNzcsImV4cCI6MjA2Mzc5MzE3N30.wy_ei_ZVJoMGbXMVqrW8NVUEgk2-EvPQYpgb9gWMW18';
        
        const { createClient } = window.supabase; 
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY); 

        window.supabaseClient = supabase; // Make client available globally
        console.log("Supabase client initialized:", window.supabaseClient);
        
        // --- UI Elements (Global Scope for all functions) ---
        const authLink = document.getElementById('authLink');
        const profileLink = document.getElementById('profileLink'); 
        const authModalElement = document.getElementById('authModal');
        const authModalTitle = document.getElementById('authModalTitle');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const academicIdInput = document.getElementById('academicIdInput');
        const referralCodeInput = document.getElementById('referralCodeInput'); 
        const authErrorElement = document.getElementById('authError');
        const loginButton = document.getElementById('loginButton');
        const signupButton = document.getElementById('signupButton');
        const switchToSignup = document.getElementById('switchToSignup');
        const switchToLogin = document.getElementById('switchToLogin');
        const authStatusElement = document.getElementById('authStatus');
        const mainAuthButton = document.getElementById('mainAuthButton');
        const currentUserDisplay = document.getElementById('currentUserDisplay');
        const userIdDisplayContainer = document.getElementById('userIdDisplay');
        const currentUserRoleSpan = document.getElementById('currentUserRole'); 
        const addEventFormContainer = document.getElementById('addEventFormContainer');
        const saveEventButton = document.getElementById('saveEventButton'); 

        const userProfileInfoDiv = document.getElementById('userProfileInfo');
        const userEmailProfileSpan = document.getElementById('userEmailProfile');
        const userAcademicIdProfileSpan = document.getElementById('userAcademicIdProfile');
        const userRoleProfileSpan = document.getElementById('userRoleProfile'); 
        const userLastSignInProfileSpan = document.getElementById('userLastSignInProfile');
        const profileInfoAvatar = document.getElementById('profileInfoAvatar');

        const profileModalElement = document.getElementById('profileModal');
        const profileAvatarPreview = document.getElementById('profileAvatarPreview');
        const profileAvatarInput = document.getElementById('profileAvatarInput');
        const profileFullNameInput = document.getElementById('profileFullNameInput');
        const profileAcademicIdInputModal = document.getElementById('profileAcademicIdInput'); 
        const profileReferralCodeSection = document.getElementById('profileReferralCodeSection');
        const profileReferralCodeInput = document.getElementById('profileReferralCodeInput');
        const profileUpdateStatus = document.getElementById('profileUpdateStatus');
        const profileAvatarUploadProgress = document.getElementById('profileAvatarUploadProgress');
        
        const ideasContainer = document.getElementById('ideasContainer');
        const loadingIdeasMsg = document.getElementById('loadingIdeas');
        const eventsContainer = document.getElementById('eventsContainer');
        const loadingEventsMsg = document.getElementById('loadingEvents');
        const localSaveEventButton = document.getElementById('saveEventButton'); 

        const generalInfoModal = document.getElementById("infoModal"); 
        const generalInfoModalTitle = document.getElementById("modalTitle");
        const generalInfoModalText = document.getElementById("modalText");
        const generalInfoModalLoading = document.getElementById("modalLoading");
        const projectDescriptionTextElement = document.getElementById("projectDescription");
        const projectDescriptionText = projectDescriptionTextElement ? projectDescriptionTextElement.textContent : "وصف مشروع التوزيع الكهربي الذكي";
        const technologiesListElement = document.getElementById("technologiesList");


        // --- Auth State ---
        window.currentUser = null; 
        let initialEventsLoaded = false; // Flag to prevent multiple event loads on init
        
        // --- Helper Functions (Global Scope) ---
        window.showStaticModal = function(title, text) {  
            if (!generalInfoModal || !generalInfoModalTitle || !generalInfoModalText || !generalInfoModalLoading) { console.error("Modal elements not found for showStaticModal"); return; }
            generalInfoModalTitle.textContent = title; 
            generalInfoModalText.innerHTML = text.replace(/\n/g, '<br>');
            generalInfoModalLoading.style.display = "none"; 
            generalInfoModalText.style.display = "block"; 
            generalInfoModal.style.display = "block";
        };

        window.showModal = function(modalId) {
            const modalToShow = document.getElementById(modalId);
            if (modalToShow) modalToShow.style.display = "block";
        }
        window.closeModal = function(modalId) {
            const modalToClose = document.getElementById(modalId);
            if (modalToClose) {
                modalToClose.style.display = "none";
                if (modalId === 'authModal' && authErrorElement) { 
                    authErrorElement.style.display = 'none';
                }
                if (modalId === 'profileModal' && profileUpdateStatus) {
                    profileUpdateStatus.style.display = 'none';
                    profileUpdateStatus.textContent = '';
                    if(profileAvatarUploadProgress) profileAvatarUploadProgress.style.display = 'none';
                }
            }
        }
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                closeModal(event.target.id);
            }
        }

        window.toggleNavbar = function() {
            document.getElementById('navbarNav').classList.toggle('hidden');
            document.getElementById('navbarNav').classList.toggle('md:flex');
        }

        // --- Auth UI and Logic ---
        function updateLoginUI() {
            const deleteIdeaButtons = document.querySelectorAll('.delete-idea-btn-supabase');
            const deleteEventButtons = document.querySelectorAll('.delete-event-btn'); 
            const saveIdeaBtn = document.getElementById('saveIdeaButton'); 

            if (window.currentUser) { 
                authLink.textContent = `تسجيل الخروج (${window.currentUser.email.split('@')[0]})`;
                authLink.onclick = handleSupabaseLogout; 
                if(profileLink) profileLink.style.display = 'inline-block'; 

                authStatusElement.textContent = `أهلاً بك، ${window.currentUser.email}! أنت مسجل الدخول.`;
                mainAuthButton.innerHTML = `<i class="fas fa-user-circle mr-2"></i> ملفي الشخصي`; 
                mainAuthButton.onclick = openProfileModal; 
                
                if(currentUserDisplay) currentUserDisplay.textContent = `${window.currentUser.email} (ID: ${window.currentUser.id.substring(0,6)}...)`;
                if(currentUserRoleSpan && window.currentUser.role) currentUserRoleSpan.textContent = `${window.currentUser.role}`;
                else if(currentUserRoleSpan) currentUserRoleSpan.textContent = `جار التحميل...`;
                if(userIdDisplayContainer) userIdDisplayContainer.style.display = 'inline-block';
                
                const userRole = window.currentUser.role || 'limited_user'; 
                console.log("updateLoginUI - User role:", userRole);
                
                if(addEventFormContainer) {
                    addEventFormContainer.style.display = (userRole === 'full_access_user' || userRole === 'admin') ? 'block' : 'none';
                }
                if(saveIdeaBtn) { 
                     saveIdeaBtn.style.display = (userRole === 'full_access_user' || userRole === 'admin') ? 'inline-flex' : 'none';
                }

                deleteIdeaButtons.forEach(btn => {
                    btn.style.display = (userRole === 'full_access_user' || userRole === 'admin') ? 'inline-flex' : 'none';
                });
                deleteEventButtons.forEach(btn => {
                     btn.style.display = (userRole === 'full_access_user' || userRole === 'admin') ? 'inline-flex' : 'none';
                }); 

                if (userProfileInfoDiv) {
                    userEmailProfileSpan.textContent = window.currentUser.email || 'غير متوفر';
                    userAcademicIdProfileSpan.textContent = window.currentUser.academic_id_profile || window.currentUser.user_metadata?.academic_id || 'لم يتم إضافته';
                    userRoleProfileSpan.textContent = window.currentUser.role || 'غير محدد';
                    userLastSignInProfileSpan.textContent = window.currentUser.last_sign_in_at ? new Date(window.currentUser.last_sign_in_at).toLocaleString('ar-EG') : 'غير معروف';
                    if(profileInfoAvatar && window.currentUser.avatar_url) profileInfoAvatar.src = window.currentUser.avatar_url;
                    else if(profileInfoAvatar) profileInfoAvatar.src = 'https://placehold.co/100x100/1a1a1a/cccccc?text=👤&font=cairo';
                    userProfileInfoDiv.style.display = 'block';
                }
            } else {
                authLink.textContent = 'تسجيل الدخول';
                authLink.onclick = handleAuthLinkClick; 
                if(profileLink) profileLink.style.display = 'none'; 

                authStatusElement.textContent = 'أنت غير مسجل الدخول حاليًا.';
                mainAuthButton.innerHTML = `<i class="fas fa-sign-in-alt mr-2"></i> تسجيل الدخول أو إنشاء حساب`;
                mainAuthButton.onclick = () => showAuthModal('login'); 
                if(currentUserDisplay) currentUserDisplay.textContent = '';
                if(currentUserRoleSpan) currentUserRoleSpan.textContent = '';
                if(userIdDisplayContainer) userIdDisplayContainer.style.display = 'none';
                if(addEventFormContainer) addEventFormContainer.style.display = 'none'; 
                if(saveIdeaBtn) saveIdeaBtn.style.display = 'none';


                deleteIdeaButtons.forEach(btn => btn.style.display = 'none');
                deleteEventButtons.forEach(btn => btn.style.display = 'none'); 
                if (userProfileInfoDiv) userProfileInfoDiv.style.display = 'none';
            }
        }
        window.updateLoginUI = updateLoginUI; 
        
        function showAuthModal(mode = 'login') {
            if (!authModalElement) return;
            authErrorElement.style.display = 'none';
            authErrorElement.textContent = '';
            emailInput.value = '';
            passwordInput.value = '';
            academicIdInput.value = '';
            if(referralCodeInput) referralCodeInput.value = '';


            if (mode === 'login') {
                authModalTitle.textContent = 'تسجيل الدخول';
                loginButton.style.display = 'block';
                signupButton.style.display = 'none';
                academicIdInput.style.display = 'none';
                if(referralCodeInput) referralCodeInput.style.display = 'none';
                switchToSignup.style.display = 'block';
                switchToLogin.style.display = 'none';
            } else { 
                authModalTitle.textContent = 'إنشاء حساب جديد';
                loginButton.style.display = 'none';
                signupButton.style.display = 'block';
                academicIdInput.style.display = 'block'; 
                if(referralCodeInput) referralCodeInput.style.display = 'block'; 
                switchToSignup.style.display = 'none';
                switchToLogin.style.display = 'block';
            }
            authModalElement.style.display = 'block';
        }
        window.showAuthModal = showAuthModal; 


        if (switchToSignup) {
            switchToSignup.onclick = (e) => { e.preventDefault(); showAuthModal('signup'); };
        }
        if (switchToLogin) {
            switchToLogin.onclick = (e) => { e.preventDefault(); showAuthModal('login'); };
        }

        window.handleAuthLinkClick = function() { 
            if (window.currentUser) { 
                handleSupabaseLogout();
            } else {
                showAuthModal('login');
            }
        }

        window.handleSupabaseLogin = async function() {
            if (!window.supabaseClient) { console.error("Supabase client not initialized in handleSupabaseLogin."); return; }
            authErrorElement.style.display = 'none';
            loginButton.disabled = true;
            loginButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> جاري الدخول...`;
            try {
                const email = emailInput.value;
                const password = passwordInput.value;
                if (!email || !password) {
                    authErrorElement.textContent = 'الرجاء إدخال البريد الإلكتروني وكلمة المرور.';
                    authErrorElement.style.display = 'block';
                    throw new Error("Missing email or password in form."); 
                }

                const { data, error } = await window.supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password,
                });

                if (error) throw error;
                closeModal('authModal');
                showStaticModal("تسجيل الدخول", "تم تسجيل دخولك بنجاح!");
            } catch (error) {
                console.error("Error logging in:", error);
                if (error.message && error.message.toLowerCase().includes('email not confirmed')) {
                    authErrorElement.textContent = 'لم يتم تأكيد بريدك الإلكتروني. الرجاء التحقق من صندوق الوارد الخاص بك (والرسائل غير المرغوب فيها) لتفعيل حسابك.';
                } else if (error.message && (error.message.toLowerCase().includes('missing email') || error.message.toLowerCase().includes('invalid login credentials'))) {
                    authErrorElement.textContent = 'بيانات تسجيل الدخول غير صحيحة. الرجاء التأكد من البريد الإلكتروني وكلمة المرور.';
                } else {
                    authErrorElement.textContent = `خطأ في تسجيل الدخول: ${error.message || 'حدث خطأ غير متوقع.'}`;
                }
                authErrorElement.style.display = 'block';
            } finally {
                loginButton.disabled = false;
                loginButton.innerHTML = `دخول`;
            }
        }

        window.handleSupabaseSignup = async function() {
            if (!window.supabaseClient) { console.error("Supabase client not initialized in handleSupabaseSignup."); return; }
            authErrorElement.style.display = 'none';
            
            const emailValue = emailInput.value.trim();
            const passwordValue = passwordInput.value;
            const academicIdValue = academicIdInput.value.trim();
            const referralCodeValue = referralCodeInput.value.trim(); 


            if (!emailValue || !passwordValue) {
                 authErrorElement.textContent = 'الرجاء إدخال البريد الإلكتروني وكلمة المرور.';
                 authErrorElement.style.display = 'block';
                 return;
            }
            if (!academicIdValue) { 
                 authErrorElement.textContent = 'الرجاء إدخال الرقم الأكاديمي.';
                 authErrorElement.style.display = 'block';
                 return;
            }

            signupButton.disabled = true;
            signupButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> جاري الإنشاء...`;
            try {
                const userMetaData = { 
                    academic_id: academicIdValue,
                    // full_name: "اسم المستخدم هنا" // يمكنك إضافة حقل للاسم الكامل إذا أردت
                };
                if (referralCodeValue) { 
                    userMetaData.referral_code = referralCodeValue;
                }

                const { data, error } = await window.supabaseClient.auth.signUp({
                    email: emailValue,
                    password: passwordValue,
                    options: {
                        data: userMetaData 
                    }
                });
                if (error) throw error;
                closeModal('authModal');
                showStaticModal("إنشاء حساب", "تم إنشاء حسابك بنجاح! الرجاء التحقق من بريدك الإلكتروني لتفعيل الحساب. سيتم تحديد صلاحياتك بناءً على كود الإحالة إذا تم استخدامه.");
            } catch (error) {
                console.error("Error signing up:", error);
                authErrorElement.textContent = `خطأ في إنشاء الحساب: ${error.message}`;
                authErrorElement.style.display = 'block';
            } finally {
                signupButton.disabled = false;
                signupButton.innerHTML = `إنشاء حساب جديد`;
            }
        }

        window.handleSupabaseLogout = async function() {
            if (!window.supabaseClient) { console.error("Supabase client not initialized in handleSupabaseLogout."); return; }
            try {
                const { error } = await window.supabaseClient.auth.signOut();
                if (error) throw error;
                // window.currentUser = null; // onAuthStateChange will handle this
                showStaticModal("تسجيل الخروج", "تم تسجيل خروجك بنجاح.");
            } catch (error) {
                console.error("Error logging out:", error);
                showStaticModal("خطأ", `حدث خطأ أثناء تسجيل الخروج: ${error.message}`);
            }
        }
        
        // --- مستمع المصادقة ---
        window.supabaseClient.auth.onAuthStateChange(async (event, session) => {
            console.log("Auth event (from module):", event, "Session:", JSON.stringify(session)); 
            let needsDataLoad = false;

            if ((event === 'INITIAL_SESSION' || event === 'SIGNED_IN') && session && session.user) {
                console.log("Auth event - User signed in or session restored. User ID:", session.user.id);
                window.currentUser = session.user;
                await fetchUserProfile(); 
                if (event === 'SIGNED_IN' || !initialEventsLoaded) { // Load data if signed in, or if it's initial session and data hasn't loaded
                    needsDataLoad = true;
                }
            } else if (event === 'SIGNED_OUT') {
                console.log("Auth event - User signed out.");
                window.currentUser = null;
                initialEventsLoaded = false; // Reset flag on sign out
                needsDataLoad = true; // Reload data to reflect signed-out state (e.g., hide delete buttons)
            } else if (event === 'USER_UPDATED' && session && session.user) { 
                console.log("Auth event - User updated. User ID:", session.user.id);
                window.currentUser = session.user; 
                await fetchUserProfile(); 
                needsDataLoad = true; // User data changed, might affect display
            } else if (event === 'INITIAL_SESSION' && !session) {
                console.log("Auth event - Initial session, no user.");
                window.currentUser = null;
                if (!initialEventsLoaded) { // Load data if it's initial session and data hasn't loaded
                    needsDataLoad = true;
                }
            }
            
            if (typeof window.updateLoginUI === 'function') {
                window.updateLoginUI(); 
            }

            if (needsDataLoad) {
                console.log("Needs data load is true, calling loadIdeas and loadEvents");
                if (typeof window.loadIdeasSupabase === 'function') {
                     window.loadIdeasSupabase();
                }
                if (typeof window.loadEvents === 'function') { 
                     window.loadEvents();
                }
                initialEventsLoaded = true; // Set flag after initial load triggered by auth state
            }
        });
        
        async function fetchUserProfile() {
            if (!window.currentUser || !window.currentUser.id) {
                console.log("fetchUserProfile: No current user or user ID. Updating UI to reflect signed-out state.");
                window.currentUser = null; 
                if (typeof window.updateLoginUI === 'function') window.updateLoginUI(); 
                return;
            }
            if (!window.supabaseClient) { console.error("Supabase client not available in fetchUserProfile"); return; }

            console.log("fetchUserProfile: Fetching profile for user ID:", window.currentUser.id);
            const { data: profileData, error: profileError } = await window.supabaseClient
                .from('profiles') 
                .select('role, academic_id, full_name, avatar_url')
                .eq('id', window.currentUser.id)
                .single();

            if (profileError && profileError.code !== 'PGRST116') { 
                console.error("Error fetching user profile:", profileError, "User ID:", window.currentUser.id);
                window.currentUser.role = 'limited_user'; 
            } else if (profileData) {
                console.log("fetchUserProfile: Profile data found for user ID:", window.currentUser.id, "Data:", profileData);
                window.currentUser.role = profileData.role || 'limited_user';
                window.currentUser.academic_id_profile = profileData.academic_id; 
                window.currentUser.full_name_profile = profileData.full_name;
                window.currentUser.avatar_url = profileData.avatar_url;
            } else {
                 console.warn("User profile not found for:", window.currentUser.id, ". A new profile row should be created by the trigger. Assigning default role 'limited_user'.");
                 window.currentUser.role = 'limited_user'; 
            }
             if (typeof window.updateLoginUI === 'function') { 
                window.updateLoginUI();
            }
        }
        window.fetchUserProfile = fetchUserProfile; 


        async function checkInitialSession() {
            console.log("checkInitialSession: Starting...");
            if (!window.supabaseClient) {
                console.error("Supabase client not available in checkInitialSession");
                if (window.supabase && typeof window.supabase.createClient === 'function') {
                     window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                     console.log("Supabase client re-initialized in checkInitialSession:", window.supabaseClient);
                } else {
                    if (typeof window.updateLoginUI === 'function') {
                        window.currentUser = null; 
                        window.updateLoginUI();
                    }
                     initialEventsLoaded = true; // Mark as loaded to prevent onAuthStateChange from re-triggering if it fires later
                    return; 
                }
            }
            try {
                const { data: { session }, error: sessionError } = await window.supabaseClient.auth.getSession();
                if(sessionError){
                    console.error("checkInitialSession - Error getting session:", sessionError);
                    window.currentUser = null;
                } else if (session && session.user) { 
                    window.currentUser = session.user;
                    console.log("checkInitialSession - User found in session, fetching profile for:", window.currentUser.id);
                    await fetchUserProfile(); 
                } else {
                    console.log("checkInitialSession - No active session found.");
                    window.currentUser = null;
                }
            } catch (e) {
                console.error("checkInitialSession - Exception during getSession:", e);
                window.currentUser = null;
            }

            if (typeof window.updateLoginUI === 'function') {
                console.log("checkInitialSession: Calling updateLoginUI. Current user:", window.currentUser);
                window.updateLoginUI();
            }
            if (!initialEventsLoaded) { // Only load if not already loaded by onAuthStateChange
                if (typeof window.loadIdeasSupabase === 'function') {
                    window.loadIdeasSupabase();
                }
                if (typeof window.loadEvents === 'function') { 
                    window.loadEvents();
                }
                initialEventsLoaded = true;
            }
             console.log("checkInitialSession: Finished.");
        }

        // --- قسم الأفكار (Ideas) ---
        const ideasTable = 'Flash'; 
        
        window.saveNewIdeaSupabase = async function(event) { 
            const saveIdeaButton = event.target.closest('button'); 
            console.log("SaveNewIdeaSupabase: Function called."); 

            if (!window.currentUser || !window.currentUser.id || !window.currentUser.role) { 
                console.warn("SaveNewIdea: User not logged in, ID, or role is missing.", window.currentUser);
                if(window.showStaticModal) window.showStaticModal("مطلوب تسجيل الدخول", "يجب تسجيل الدخول ووجود صلاحيات لحفظ الأفكار."); 
                window.showAuthModal('login'); 
                if(saveIdeaButton) { 
                    saveIdeaButton.disabled = false;
                    saveIdeaButton.innerHTML = `<i class="fas fa-plus-circle mr-2"></i> حفظ الفكرة`;
                }
                return; 
            }
            
            if (window.currentUser.role !== 'full_access_user' && window.currentUser.role !== 'admin') {
                console.warn("SaveNewIdea: User does not have permission to save ideas. Role:", window.currentUser.role);
                if(window.showStaticModal) window.showStaticModal("غير مصرح به", "ليس لديك الصلاحيات الكافية لحفظ الأفكار.");
                if(saveIdeaButton) {
                    saveIdeaButton.disabled = false;
                    saveIdeaButton.innerHTML = `<i class="fas fa-plus-circle mr-2"></i> حفظ الفكرة`;
                }
                return;
            }


            console.log("SaveNewIdeaSupabase: Current user check. ID:", window.currentUser.id, "User Object:", window.currentUser);


            const ideaInput = document.getElementById('newIdeaInput');
            const ideaText = ideaInput.value.trim();
            if (ideaText === "") { 
                if(window.showStaticModal) window.showStaticModal("خطأ", "الرجاء إدخال نص للفكرة."); 
                if(saveIdeaButton) { 
                     saveIdeaButton.disabled = false;
                     saveIdeaButton.innerHTML = `<i class="fas fa-plus-circle mr-2"></i> حفظ الفكرة`;
                }
                return;
            }
            
            if(saveIdeaButton) {
                saveIdeaButton.disabled = true;
                saveIdeaButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> جاري الحفظ...`;
            }
            
            const userIdToInsert = window.currentUser.id;
            console.log(`SaveNewIdeaSupabase: Attempting to save idea to table '${ideasTable}' with user_id:`, userIdToInsert);

            try {
                if (!window.supabaseClient) { console.error("Supabase client not available in saveNewIdeaSupabase"); throw new Error("Supabase client not initialized.");}
                const { data, error } = await window.supabaseClient
                    .from(ideasTable) 
                    .insert([ { text: ideaText, user_id: userIdToInsert } ]) 
                    .select(); 
                if (error) throw error;
                ideaInput.value = "";
                if(window.showStaticModal) window.showStaticModal("نجاح", "تم حفظ الفكرة بنجاح!");
                loadIdeasSupabase(); 
            } catch (error) {
                console.error(`Error adding idea to Supabase table '${ideasTable}': `, error);
                let userErrorMessage = `فشل حفظ الفكرة: ${error.message}.`;
                 if (error.message && error.message.toLowerCase().includes('violates row-level security policy')) {
                     userErrorMessage = `فشل حفظ الفكرة: تم رفض العملية بواسطة سياسة الأمان (RLS). تأكد أن سياسة INSERT لجدول '${ideasTable}' تسمح لك بإضافة بيانات بناءً على دورك الحالي ('${window.currentUser.role}').`;
                } else {
                    userErrorMessage += ` تأكد أن جدول '${ideasTable}' موجود وأن عمود 'user_id' يقبل القيمة المُرسلة.`;
                }
                if(window.showStaticModal) window.showStaticModal("خطأ الحفظ", userErrorMessage);
            } finally {
                if(saveIdeaButton) {
                    saveIdeaButton.disabled = false;
                    saveIdeaButton.innerHTML = `<i class="fas fa-plus-circle mr-2"></i> حفظ الفكرة`;
                }
            }
         };

        window.loadIdeasSupabase = async function() { 
            if (!ideasContainer) { console.warn("Ideas container not found"); return; }
            if (loadingIdeasMsg) loadingIdeasMsg.style.display = 'block';
            if (!window.supabaseClient) { console.error("Supabase client not available in loadIdeasSupabase"); if (loadingIdeasMsg) loadingIdeasMsg.textContent = "خطأ: Supabase client غير مهيأ."; return; }
            try {
                const { data: ideas, error } = await window.supabaseClient
                    .from(ideasTable) 
                    .select(`id, created_at, text, user_id`) 
                    .order('created_at', { ascending: false }); 
                if (error) {
                    console.error(`Error fetching ideas from Supabase table '${ideasTable}' (details): `, error); 
                    throw error;
                }
                ideasContainer.innerHTML = ''; 
                if (!ideas || ideas.length === 0) { 
                    ideasContainer.innerHTML = `<p class="text-gray-400 col-span-full text-center text-lg">لا توجد أفكار محفوظة. كن أول من يضيف فكرة!</p>`;
                } else {
                    for (const idea of ideas) { 
                        const ideaElement = document.createElement('div');
                        ideaElement.className = 'idea-card p-5 rounded-lg shadow-md flex justify-between items-start text-gray-200';
                        ideaElement.style.opacity = '0'; ideaElement.style.animation = 'slideInUp 0.5s ease-out forwards';
                        let creationDate = idea.created_at ? new Date(idea.created_at).toLocaleDateString('ar-EG',{year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'}) : 'غير متوفر';
                        
                        let authorNameDisplay = `مستخدم (${idea.user_id ? idea.user_id.substring(0,6) : 'غير معروف'}...)`; 
                         if (window.currentUser && window.currentUser.id === idea.user_id && window.currentUser.email) {
                           authorNameDisplay = window.currentUser.email.split('@')[0];
                         }

                        const canDelete = window.currentUser && window.currentUser.id === idea.user_id && (window.currentUser.role === 'full_access_user' || window.currentUser.role === 'admin');
                        ideaElement.innerHTML = `
                            <div class="flex-grow">
                                <p class="text-lg mb-2">${idea.text}</p>
                                <p class="text-xs text-gray-400">أضيف بواسطة: ${authorNameDisplay}</p>
                                <p class="text-xs text-gray-400">بتاريخ: ${creationDate}</p>
                            </div>
                            ${canDelete ? `<button onclick="deleteIdeaSupabase('${idea.id}')" class="btn btn-danger text-xs py-1 px-2 ml-3 self-start flex items-center delete-idea-btn-supabase">
                                <i class="fas fa-trash-alt mr-1"></i> حذف
                            </button>` : ''}
                        `;
                        ideasContainer.appendChild(ideaElement);
                    }
                }
            } catch (error) { 
                console.error(`Error fetching ideas from Supabase table '${ideasTable}' (catch block): `, error); 
                if (ideasContainer) ideasContainer.innerHTML = `<p class="text-red-400 col-span-full text-center">حدث خطأ تحميل الأفكار: ${error.message}. تأكد من أن جدول '${ideasTable}' موجود وأن الأعمدة المطلوبة (id, created_at, text, user_id) موجودة وأن لديك الصلاحيات لقراءتها.</p>`;
            } finally {
                if (loadingIdeasMsg) loadingIdeasMsg.style.display = 'none';
            }
         }

        window.deleteIdeaSupabase = async function(ideaId) { 
            if (!window.currentUser) { if(window.showStaticModal) window.showStaticModal("خطأ", "يجب تسجيل الدخول للحذف."); return; }
            if (!window.supabaseClient) { console.error("Supabase client not available in deleteIdeaSupabase"); return; }
            const { data: ideaToDelete, error: fetchError } = await window.supabaseClient.from(ideasTable).select('user_id').eq('id', ideaId).single();
            if (fetchError || !ideaToDelete || (ideaToDelete.user_id !== window.currentUser.id && window.currentUser.role !== 'admin' && window.currentUser.role !== 'full_access_user' ) ) {
                 if(window.showStaticModal) window.showStaticModal("غير مصرح به", "لا يمكنك حذف هذه الفكرة."); return;
            }
            const userConfirmed = await new Promise(resolve => {
                window.showStaticModal("تأكيد الحذف", "هل أنت متأكد أنك تريد حذف هذه الفكرة؟<br><br><div class='flex justify-center space-x-3 space-x-reverse'><button id='confirmDeleteBtnModalIdea' class='btn btn-danger'>نعم، احذف</button><button id='cancelDeleteBtnModalIdea' class='btn btn-secondary'>إلغاء</button></div>");
                document.getElementById('confirmDeleteBtnModalIdea').onclick = () => { window.closeModal('infoModal'); resolve(true); };
                document.getElementById('cancelDeleteBtnModalIdea').onclick = () => { window.closeModal('infoModal'); resolve(false); };
            });
            if (!userConfirmed) return;
            try {
                const { error } = await window.supabaseClient.from(ideasTable).delete().match({ id: ideaId }); 
                if (error) throw error;
                if(window.showStaticModal) window.showStaticModal("نجاح", "تم حذف الفكرة بنجاح.");
                loadIdeasSupabase(); 
            } catch (error) { 
                console.error("Error deleting idea: ", error); 
                if(window.showStaticModal) window.showStaticModal("خطأ الحذف", `لم نتمكن من حذف الفكرة: ${error.message}`);
            }
         };

        // --- قسم الأحداث (Events) ---
        const eventsTable = 'project_events'; 
        const eventsStorageBucket = 'events-images'; 
        // const eventsContainer, loadingEventsMsg, localSaveEventButton are already defined in the global script

        window.saveNewEvent = async function(event) { 
            const saveEventBtnInstance = event.target.closest('button');
            console.log("SaveNewEvent: Function called."); 

            if (!window.currentUser || !window.currentUser.id || !window.currentUser.role) { 
                console.warn("SaveNewEvent: User not logged in, ID, or role is missing. Current user object:", window.currentUser);
                if (window.showStaticModal) window.showStaticModal("مطلوب تسجيل الدخول", "يجب تسجيل الدخول ووجود صلاحيات لإضافة أحداث.");
                window.showAuthModal('login');
                if(saveEventBtnInstance) {
                    saveEventBtnInstance.disabled = false;
                    saveEventBtnInstance.innerHTML = `<i class="fas fa-calendar-plus mr-2"></i> إضافة الحدث`;
                }
                return;
            }
            
            if (window.currentUser.role !== 'full_access_user' && window.currentUser.role !== 'admin') {
                console.warn("SaveNewEvent: User does not have permission to save events. Role:", window.currentUser.role);
                if(window.showStaticModal) window.showStaticModal("غير مصرح به", "ليس لديك الصلاحيات الكافية لإضافة أحداث.");
                 if(saveEventBtnInstance) {
                    saveEventBtnInstance.disabled = false;
                    saveEventBtnInstance.innerHTML = `<i class="fas fa-calendar-plus mr-2"></i> إضافة الحدث`;
                }
                return;
            }
            
            console.log("SaveNewEvent: Current user check. ID:", window.currentUser.id, "User Role:", window.currentUser.role, "User Object:", JSON.stringify(window.currentUser, null, 2));


            const title = document.getElementById('eventTitleInput').value.trim();
            const description = document.getElementById('eventDescriptionInput').value.trim();
            const event_date = document.getElementById('eventDateInput').value;
            const imageFileInput = document.getElementById('eventImageFileInput');
            const imageFile = imageFileInput.files[0];

            if (!title || !description || !event_date) {
                if (window.showStaticModal) window.showStaticModal("بيانات ناقصة", "الرجاء ملء حقول العنوان والوصف والتاريخ.");
                 if(saveEventBtnInstance) {
                    saveEventBtnInstance.disabled = false;
                    saveEventBtnInstance.innerHTML = `<i class="fas fa-calendar-plus mr-2"></i> إضافة الحدث`;
                }
                return;
            }
            
            if(saveEventBtnInstance) {
                saveEventBtnInstance.disabled = true;
                saveEventBtnInstance.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> جاري الحفظ...`;
            }

            let uploadedImageUrl = null;
            const progressDiv = document.getElementById('imageUploadProgress');
            const progressBar = document.getElementById('imageUploadProgressBar');

            try {
                if (imageFile) {
                    const filePath = `public/${window.currentUser.id}/${Date.now()}_${imageFile.name.replace(/\s+/g, '_')}`; 
                    if(progressDiv) progressDiv.style.display = 'block';
                    if(progressBar) { progressBar.style.width = '0%'; progressBar.textContent = '0%';}

                    if (!window.supabaseClient) { console.error("Supabase client not available for storage upload"); throw new Error("Supabase client not initialized.");}
                    const { data, error: uploadError } = await window.supabaseClient.storage
                        .from(eventsStorageBucket) 
                        .upload(filePath, imageFile, {
                            cacheControl: '3600',
                            upsert: false,
                        });
                    
                    if(progressBar) { progressBar.style.width = '50%'; progressBar.textContent = '50% (جاري الرفع)';}

                    if (uploadError) throw uploadError;

                    const { data: urlData } = window.supabaseClient.storage
                        .from(eventsStorageBucket) 
                        .getPublicUrl(data.path);
                    
                    uploadedImageUrl = urlData.publicUrl;
                    if(progressBar) { progressBar.style.width = '100%'; progressBar.textContent = 'اكتمل الرفع!';}
                }
                
                const userIdToInsertEvents = window.currentUser.id; 
                console.log(`SaveNewEvent: Attempting to save event to table '${eventsTable}' with user_id:`, userIdToInsertEvents);


                if (!window.supabaseClient) { console.error("Supabase client not available in saveNewEvent before insert"); throw new Error("Supabase client not initialized.");}
                const { error: insertError } = await window.supabaseClient
                    .from(eventsTable)
                    .insert([{
                        title: title,
                        description: description,
                        event_date: event_date,
                        image_url: uploadedImageUrl,
                        user_id: userIdToInsertEvents 
                    }]);
                
                if (insertError) throw insertError;
                
                if(window.showStaticModal) window.showStaticModal("نجاح", "تم إضافة الحدث بنجاح!");
                document.getElementById('eventTitleInput').value = '';
                document.getElementById('eventDescriptionInput').value = '';
                document.getElementById('eventDateInput').value = '';
                imageFileInput.value = ''; 
                if(progressDiv) progressDiv.style.display = 'none';
                if(progressBar) {progressBar.style.width = '0%'; progressBar.textContent = '0%';}

                loadEvents(); 

            } catch (error) {
                console.error(`Error saving event to table '${eventsTable}':`, error);
                let errorMessage = `فشل حفظ الحدث: ${error.message}.`;
                if (error.message && error.message.toLowerCase().includes('bucket not found')) {
                    errorMessage = `فشل حفظ الحدث: لم يتم العثور على حاوية التخزين (Bucket) بالاسم '${eventsStorageBucket}'. يرجى التحقق من اسم الـ Bucket في Supabase Storage وأنه موجود وعام.`;
                } else if (error.message && error.message.toLowerCase().includes('violates row-level security policy')) {
                     errorMessage = `فشل حفظ الحدث: تم رفض العملية بواسطة سياسة الأمان (RLS). تأكد أن سياسة INSERT لجدول '${eventsTable}' تسمح للمستخدم الحالي (الدور: '${window.currentUser?.role || 'غير معروف'}') بإضافة بيانات، وأن شرط 'WITH CHECK (auth.uid() = user_id)' يتم استيفاؤه. قيمة user_id المرسلة: ('${window.currentUser ? window.currentUser.id : 'USER_ID_IS_NULL_OR_UNDEFINED'}'). تأكد أيضًا أن RLS مفعلة للجدول.`;
                }
                else {
                    errorMessage += ` تأكد أن جدول '${eventsTable}' موجود وأن عمود 'user_id' يقبل القيمة المُرسلة.`;
                }
                if (window.showStaticModal) window.showStaticModal("خطأ", errorMessage);

                if(progressDiv && imageFile) progressDiv.style.display = 'block'; 
                if(progressBar && imageFile) { progressBar.style.width = '0%'; progressBar.textContent = 'فشل الرفع';}

            } finally {
                if(saveEventBtnInstance) {
                    saveEventBtnInstance.disabled = false;
                    saveEventBtnInstance.innerHTML = `<i class="fas fa-calendar-plus mr-2"></i> إضافة الحدث`;
                }
            }
        }

        window.loadEvents = async function() {
            if (!eventsContainer) { console.warn("Events container not found"); return; }
            if (loadingEventsMsg) loadingEventsMsg.style.display = 'block';
            if (!window.supabaseClient) { console.error("Supabase client not available in loadEvents"); if(loadingEventsMsg) loadingEventsMsg.textContent = "خطأ: Supabase client غير مهيأ."; return; }

            let eventsHTML = ''; //  لتجميع HTML للأحداث

            try {
                const { data: events, error } = await window.supabaseClient
                    .from(eventsTable)
                    .select(`id, title, description, event_date, image_url, user_id`) 
                    .order('event_date', { ascending: false });

                if (error) {
                    console.error(`Error loading events from table '${eventsTable}' (details):`, error); 
                    throw error;
                }
                
                if (!events || events.length === 0) {
                    eventsHTML = '<p class="text-gray-400 col-span-full text-center text-lg">لا توجد أحداث أو منشورات حالياً.</p>';
                } else {
                     for (const [index, event] of events.entries()) { //  إضافة index
                        let eventDateFormatted = event.event_date ? new Date(event.event_date).toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' }) : 'غير محدد';
                        let imageHtml = event.image_url ? `<img src="${event.image_url}" alt="${event.title}" class="event-image-display w-full h-auto max-h-60 object-cover rounded mb-3" onerror="this.style.display='none'; this.parentElement.insertAdjacentHTML('beforeend', '<p class=\\'text-xs text-red-400 text-center\\'>تعذر تحميل الصورة.</p>')">` : '';
                        
                        let authorName = `مستخدم (${event.user_id ? event.user_id.substring(0,6) : 'غير معروف'}...)`; 
                        if (event.user_id) {
                            try {
                                const { data: profile, error: profileError } = await window.supabaseClient
                                    .from('profiles')
                                    .select('full_name, email') 
                                    .eq('id', event.user_id)
                                    .single();
                                if (profile) {
                                    authorName = profile.full_name || profile.email?.split('@')[0] || authorName;
                                } else if (profileError && profileError.code !== 'PGRST116') { 
                                    console.warn(`Could not fetch profile for event author ${event.user_id}:`, profileError.message);
                                }
                            } catch (e) {
                                console.warn(`Exception fetching profile for event author ${event.user_id}:`, e);
                            }
                        }


                        const canDelete = window.currentUser && window.currentUser.id === event.user_id && (window.currentUser.role === 'full_access_user' || window.currentUser.role === 'admin');

                        // HTML for reaction buttons
                        const reactionTypes = [
                            { type: 'like', emoji: '👍' }, { type: 'love', emoji: '❤️' },
                            { type: 'laugh', emoji: '😂' }, { type: 'wow', emoji: '😮' },
                            { type: 'sad', emoji: '😢' }, { type: 'angry', emoji: '😠' }
                        ];
                        let reactionButtonsHTML = '<div class="reaction-buttons">';
                        reactionTypes.forEach(reaction => {
                            reactionButtonsHTML += `
                                <button onclick="handleReaction(${event.id}, '${reaction.type}', this)" class="reaction-btn" data-reaction-type="${reaction.type}">
                                    <span class="emoji">${reaction.emoji}</span>
                                    <span class="count reaction-count-${event.id}-${reaction.type}">0</span>
                                </button>
                            `;
                        });
                        reactionButtonsHTML += '</div>';

                        // HTML for comments section
                        const commentsSectionHTML = `
                            <div class="comments-section mt-4 pt-4 border-t border-gray-700">
                                <h5 class="text-md font-semibold mb-2 text-gray-300">التعليقات (<span class="comment-count-${event.id}">0</span>)</h5>
                                <div class="event-comments-list-${event.id} mb-4 max-h-48 overflow-y-auto">
                                    <p class="text-sm text-gray-500 no-comments-yet-${event.id}">لا توجد تعليقات بعد. كن أول من يعلق!</p> 
                                </div>
                                <div class="add-comment-form mt-4">
                                    <h6 class="text-sm font-semibold mb-1 text-gray-300">أضف تعليقك:</h6>
                                    <input type="text" placeholder="اسمك (مطلوب)" class="form-input comment-name-input-${event.id} text-sm p-2 mb-1" ${window.currentUser ? 'style="display:none;"' : ''}>
                                    <input type="email" placeholder="بريدك الإلكتروني (مطلوب)" class="form-input comment-email-input-${event.id} text-sm p-2 mb-1" ${window.currentUser ? 'style="display:none;"' : ''}>
                                    <textarea placeholder="اكتب تعليقك هنا..." rows="2" class="form-textarea comment-text-input-${event.id} text-sm p-2 mb-1"></textarea>
                                    <button onclick="saveNewComment(${event.id}, this.closest('.event-card'))" class="btn btn-secondary btn-sm py-1 px-3 comment-submit-button">
                                        <i class="fas fa-paper-plane mr-1"></i>إرسال
                                    </button>
                                    <p class="comment-status-message-${event.id} text-xs mt-1" style="display:none;"></p>
                                </div>
                            </div>
                        `;
                        //  إضافة data-event-id لبطاقة الحدث
                        eventsHTML += `
                            <div class="event-card p-5 rounded-lg shadow-md text-gray-200 flex flex-col" data-event-id="${event.id}" style="opacity:0; animation: slideInUp 0.5s ease-out forwards; --animation-delay: ${index * 0.08}s;">
                                <div>
                                    ${imageHtml}
                                    <h4 class="text-xl font-bold text-00f0ff mb-2">${event.title}</h4>
                                    <p class="text-sm text-gray-400 mb-1">تاريخ الحدث: ${eventDateFormatted}</p>
                                    <p class="text-gray-300 mb-3 leading-relaxed">${event.description.replace(/\n/g, '<br>')}</p>
                                </div>
                                ${reactionButtonsHTML}
                                <div class="mt-auto pt-3 border-t border-gray-700 flex justify-between items-center">
                                    <p class="text-xs text-gray-500">أضيف بواسطة: ${authorName}</p>
                                    ${canDelete ? `<button onclick="deleteEvent('${event.id}', ${event.image_url ? `'${event.image_url}'` : null})" class="btn btn-danger btn-sm text-xs py-1 px-2 flex items-center delete-event-btn">
                                        <i class="fas fa-trash-alt mr-1"></i> حذف
                                    </button>` : ''}
                                </div>
                                ${commentsSectionHTML}
                            </div>
                        `;
                    }
                }
                eventsContainer.innerHTML = eventsHTML; // تعيين المحتوى مرة واحدة

                // الآن بعد إضافة جميع عناصر الأحداث إلى DOM، يمكننا استدعاء تحميل التعليقات والتفاعلات
                if (events && events.length > 0) {
                    events.forEach(event => {
                        const eventCardElement = eventsContainer.querySelector(`.event-card[data-event-id="${event.id}"]`);
                        if (eventCardElement) {
                            const commentsListEl = eventCardElement.querySelector(`.event-comments-list-${event.id}`);
                            const commentCountEl = eventCardElement.querySelector(`.comment-count-${event.id}`);
                            const noCommentsEl = commentsListEl ? commentsListEl.querySelector(`.no-comments-yet-${event.id}`) : null; 
                            
                            if (commentsListEl && commentCountEl && noCommentsEl) {
                                loadCommentsForEvent(event.id, commentsListEl, commentCountEl, noCommentsEl);
                            } else {
                                console.warn(`Could not find all comment elements for event ${event.id} after render.`);
                            }
                            loadReactionsForEvent(event.id, eventCardElement);
                        } else {
                             console.warn(`Could not find event card element for event ${event.id} after render.`);
                        }
                    });
                }

            } catch (error) {
                console.error(`Error loading events from table '${eventsTable}' (catch block):`, error);
                if(eventsContainer) eventsContainer.innerHTML = `<p class="text-red-400 col-span-full text-center">حدث خطأ أثناء تحميل الأحداث: ${error.message}. تأكد من أن جدول '${eventsTable}' والأعمدة المطلوبة (خاصة 'id') موجودة وأن لديك الصلاحيات لقراءتها.</p>`;
            } finally {
                if(loadingEventsMsg) loadingEventsMsg.style.display = 'none';
            }
        }
        window.loadEvents = loadEvents; 

        window.deleteEvent = async function(eventId, imageUrl) {
            if (!window.currentUser) { if (window.showStaticModal) window.showStaticModal("خطأ", "يجب تسجيل الدخول للحذف."); return; }
            if (!window.supabaseClient) { console.error("Supabase client not available in deleteEvent"); return; }

            const { data: eventToDelete, error: fetchError } = await window.supabaseClient.from(eventsTable).select('user_id, image_url').eq('id', eventId).single();
            if (fetchError || !eventToDelete || (eventToDelete.user_id !== window.currentUser.id && window.currentUser.role !== 'admin' && window.currentUser.role !== 'full_access_user')) {
                 if(window.showStaticModal) window.showStaticModal("غير مصرح به", "لا يمكنك حذف هذا الحدث."); return;
            }

            const confirmed = await new Promise(resolve => {
                window.showStaticModal("تأكيد الحذف", "هل أنت متأكد أنك تريد حذف هذا الحدث؟ سيتم حذف الصورة المرتبطة به (إن وجدت) بشكل دائم.<br><br><div class='flex justify-center space-x-3 space-x-reverse'><button id='confirmDeleteBtnModalEvent' class='btn btn-danger'>نعم، احذف</button><button id='cancelDeleteBtnModalEvent' class='btn btn-secondary'>إلغاء</button></div>");
                document.getElementById('confirmDeleteBtnModalEvent').onclick = () => { window.closeModal('infoModal'); resolve(true); };
                document.getElementById('cancelDeleteBtnModalEvent').onclick = () => { window.closeModal('infoModal'); resolve(false); };
            });

            if (!confirmed) return;

            try {
                if (eventToDelete.image_url) { 
                    const bucketName = eventsStorageBucket; 
                    const urlParts = eventToDelete.image_url.split('/');
                    let filePath = '';
                    const bucketNameIndex = urlParts.indexOf(bucketName);
                    if (bucketNameIndex !== -1 && bucketNameIndex < urlParts.length -1) {
                        filePath = urlParts.slice(bucketNameIndex + 1).join('/');
                    }
                    
                    if (filePath) {
                        console.log("Attempting to delete image from storage. Bucket:", bucketName, "Path:", filePath);
                        const { error: storageError } = await window.supabaseClient.storage.from(bucketName).remove([filePath]);
                        if (storageError) console.warn("Could not delete image from storage:", storageError.message, "Path attempted:", filePath);
                        else console.log("Image deleted from storage:", filePath);
                    } else {
                        console.warn("Could not extract valid file path from image URL:", eventToDelete.image_url);
                    }
                }

                const { error: dbError } = await window.supabaseClient
                    .from(eventsTable)
                    .delete()
                    .match({ id: eventId }); 
                
                if (dbError) throw dbError;

                if (window.showStaticModal) window.showStaticModal("نجاح", "تم حذف الحدث بنجاح.");
                loadEvents(); 

            } catch (error) {
                console.error("Error deleting event:", error);
                if (window.showStaticModal) window.showStaticModal("خطأ", `فشل حذف الحدث: ${error.message}`);
            }
        }
        
        // --- Profile Management Functions ---
        window.openProfileModal = async function() {
            if (!window.currentUser || !window.supabaseClient) {
                showStaticModal("خطأ", "يجب تسجيل الدخول لعرض الملف الشخصي.");
                return;
            }
            // Fetch fresh profile data
            await fetchUserProfile(); // Ensure currentUser.role and other profile details are up-to-date

            if (!window.currentUser) { // Re-check after fetchUserProfile
                 showStaticModal("خطأ", "لم نتمكن من تحميل بيانات ملفك الشخصي.");
                 return;
            }
            
            profileFullNameInput.value = window.currentUser.full_name_profile || '';
            profileAcademicIdInputModal.value = window.currentUser.academic_id_profile || window.currentUser.user_metadata?.academic_id || '';
            profileAvatarPreview.src = window.currentUser.avatar_url || 'https://placehold.co/120x120/2a2a2a/cccccc?text=👤&font=cairo';
            
            if (profileReferralCodeSection) {
                profileReferralCodeSection.style.display = (window.currentUser.role === 'limited_user') ? 'block' : 'none';
            }
            profileReferralCodeInput.value = ''; // Clear previous input

            showModal('profileModal');
        }

        window.previewProfileAvatar = function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    profileAvatarPreview.src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        }

        window.updateUserProfile = async function() {
            if (!window.currentUser || !window.supabaseClient) {
                showStaticModal("خطأ", "يجب تسجيل الدخول لتحديث الملف الشخصي.");
                return;
            }
             console.log("updateUserProfile: Current user before update:", JSON.stringify(window.currentUser, null, 2));
             console.log("updateUserProfile: Attempting to update profile for user ID:", window.currentUser.id);


            const fullName = profileFullNameInput.value.trim();
            const academicId = profileAcademicIdInputModal.value.trim();
            const avatarFile = profileAvatarInput.files[0];
            
            const profileUpdateBtn = profileModalElement.querySelector('button[onclick="updateUserProfile()"]');
            if(profileUpdateBtn) {
                profileUpdateBtn.disabled = true;
                profileUpdateBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> جاري الحفظ...`;
            }
            if(profileUpdateStatus) profileUpdateStatus.style.display = 'none';
            if(profileAvatarUploadProgress) profileAvatarUploadProgress.style.display = 'none';


            try {
                let avatarPublicUrl = window.currentUser.avatar_url; 

                if (avatarFile) {
                    if(profileAvatarUploadProgress) profileAvatarUploadProgress.style.display = 'block';
                    if(profileAvatarUploadProgress) profileAvatarUploadProgress.textContent = 'جاري رفع الصورة...';

                    const filePath = `public/${window.currentUser.id}/${Date.now()}_${avatarFile.name.replace(/\s+/g, '_')}`;
                    const avatarBucket = 'personal-image'; 
                    
                    const { data: uploadData, error: uploadError } = await window.supabaseClient.storage
                        .from(avatarBucket) 
                        .upload(filePath, avatarFile, {
                            cacheControl: '3600',
                            upsert: true 
                        });

                    if (uploadError) throw uploadError;
                    
                    const { data: urlData } = window.supabaseClient.storage.from(avatarBucket).getPublicUrl(uploadData.path);
                    avatarPublicUrl = urlData.publicUrl;
                    if(profileAvatarUploadProgress) profileAvatarUploadProgress.textContent = 'اكتمل رفع الصورة!';
                }

                const updates = {
                    id: window.currentUser.id, 
                    full_name: fullName,
                    academic_id: academicId,
                    avatar_url: avatarPublicUrl,
                    updated_at: new Date().toISOString(),
                };
                

                console.log("updateUserProfile: Attempting to upsert 'profiles' table with data:", updates, "for user ID:", window.currentUser.id);

                const { error: profileError } = await window.supabaseClient
                    .from('profiles')
                    .upsert(updates, { onConflict: 'id' }); 

                if (profileError) throw profileError;

                
                window.currentUser.full_name_profile = fullName;
                window.currentUser.academic_id_profile = academicId;
                window.currentUser.avatar_url = avatarPublicUrl;
                
                await fetchUserProfile(); 
                
                if(profileUpdateStatus) {
                    profileUpdateStatus.textContent = 'تم حفظ التغييرات بنجاح!';
                    profileUpdateStatus.className = 'text-sm text-green-400 text-center mb-4';
                    profileUpdateStatus.style.display = 'block';
                }
                updateLoginUI(); 
                setTimeout(() => { 
                    if(profileUpdateStatus) profileUpdateStatus.style.display = 'none';
                    if(profileAvatarUploadProgress && !avatarFile) profileAvatarUploadProgress.style.display = 'none'; 
                }, 3000);


            } catch (error) {
                console.error("Error updating profile:", error);
                let userErrorMessage = `فشل تحديث الملف الشخصي: ${error.message}.`;
                if (error.message && error.message.toLowerCase().includes('bucket not found')) {
                    userErrorMessage = `فشل تحديث الملف الشخصي: لم يتم العثور على حاوية التخزين (Bucket) بالاسم 'personal-image'. يرجى التأكد من إنشائها في Supabase Storage وجعلها عامة.`;
                } else if (error.message && error.message.toLowerCase().includes('violates row-level security policy')) {
                     userErrorMessage = `فشل تحديث الملف الشخصي: تم رفض العملية بواسطة سياسة الأمان (RLS). تأكد أن سياسات INSERT و UPDATE لجدول 'profiles' تسمح لك بتعديل ملفك الشخصي (عادةً بشرط auth.uid() = id). تأكد أيضًا أن RLS مفعلة لجدول 'profiles' وأن الـ trigger 'handle_new_user' يعمل بشكل صحيح لإنشاء صف لك في جدول 'profiles' عند التسجيل. User ID being used: ${window.currentUser?.id}`;
                }
                 if(profileUpdateStatus) {
                    profileUpdateStatus.textContent = userErrorMessage;
                    profileUpdateStatus.className = 'text-sm text-red-400 text-center mb-4';
                    profileUpdateStatus.style.display = 'block';
                }
                 if(profileAvatarUploadProgress && avatarFile) profileAvatarUploadProgress.textContent = 'فشل رفع الصورة.';
            } finally {
                 const profileUpdateBtn = profileModalElement.querySelector('button[onclick="updateUserProfile()"]');
                 if(profileUpdateBtn) {
                    profileUpdateBtn.disabled = false;
                    profileUpdateBtn.innerHTML = `حفظ التغييرات`;
                }
            }
        }

        window.submitReferralCode = async function() {
            if (!window.currentUser || !window.supabaseClient) {
                showStaticModal("خطأ", "يجب تسجيل الدخول أولاً.");
                return;
            }
            const enteredCode = profileReferralCodeInput.value.trim();
            const referralStatusDiv = profileUpdateStatus; 

            if (!enteredCode) {
                if(referralStatusDiv) {
                    referralStatusDiv.textContent = "الرجاء إدخال كود الإحالة.";
                    referralStatusDiv.className = 'text-sm text-yellow-400 text-center mb-4';
                    referralStatusDiv.style.display = 'block';
                }
                return;
            }

            if (enteredCode === 'MinaOmarMena') {
                console.log("Attempting to update role to full_access_user for user:", window.currentUser.id);
                const { error: updateError } = await window.supabaseClient
                    .from('profiles')
                    .update({ role: 'full_access_user', updated_at: new Date().toISOString() })
                    .eq('id', window.currentUser.id);

                if (updateError) {
                    console.error("Error updating role:", updateError);
                    if(referralStatusDiv) {
                        referralStatusDiv.textContent = `فشل تحديث الدور: ${updateError.message}`;
                        referralStatusDiv.className = 'text-sm text-red-400 text-center mb-4';
                        referralStatusDiv.style.display = 'block';
                    }
                } else {
                    window.currentUser.role = 'full_access_user'; 
                    if(referralStatusDiv) {
                        referralStatusDiv.textContent = "تم تفعيل كود الإحالة بنجاح! تم ترقية صلاحياتك.";
                        referralStatusDiv.className = 'text-sm text-green-400 text-center mb-4';
                        referralStatusDiv.style.display = 'block';
                    }
                    if(profileReferralCodeSection) profileReferralCodeSection.style.display = 'none'; 
                    updateLoginUI(); 
                    await fetchUserProfile(); // Re-fetch profile to confirm role update from DB
                }
            } else {
                 if(referralStatusDiv) {
                    referralStatusDiv.textContent = "كود الإحالة غير صحيح.";
                    referralStatusDiv.className = 'text-sm text-red-400 text-center mb-4';
                    referralStatusDiv.style.display = 'block';
                }
            }
             setTimeout(() => { if(referralStatusDiv) referralStatusDiv.style.display = 'none';}, 4000);
        }

        // --- Comment Functions ---
        const commentsTable = 'event_comments';

        async function loadCommentsForEvent(eventId, commentsListElement, commentCountElement, noCommentsYetElement) {
            let errorMessage = "";
            if (!window.supabaseClient) errorMessage += "Supabase client is not available. ";
            if (!commentsListElement) errorMessage += `commentsListElement for event ID ${eventId} not found. `;
            if (!commentCountElement) errorMessage += `commentCountElement for event ID ${eventId} not found. `;
            if (!noCommentsYetElement) errorMessage += `noCommentsYetElement for event ID ${eventId} not found. `;

            if (errorMessage) {
                console.error("Error in loadCommentsForEvent prerequisites: " + errorMessage + "Event ID:", eventId);
                if(commentsListElement) commentsListElement.innerHTML = `<p class="text-red-500 text-xs">خطأ في تهيئة قسم التعليقات.</p>`;
                return;
            }
            
            try {
                const { data: comments, error } = await window.supabaseClient
                    .from(commentsTable)
                    .select('id, commenter_name, commenter_email, comment_text, created_at, user_id')
                    .eq('event_id', eventId)
                    .order('created_at', { ascending: true });

                if (error) throw error;

                commentsListElement.innerHTML = ''; 
                commentCountElement.textContent = comments.length;

                if (comments.length === 0) {
                    noCommentsYetElement.style.display = 'block';
                } else {
                    noCommentsYetElement.style.display = 'none';
                    comments.forEach(comment => {
                        const commentDiv = document.createElement('div');
                        commentDiv.className = 'comment';
                        const commentDate = comment.created_at ? new Date(comment.created_at).toLocaleString('ar-EG', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'غير معروف';
                        
                        let deleteButtonHtml = '';
                        if (window.currentUser && window.currentUser.id === comment.user_id) {
                            deleteButtonHtml = `<button onclick="deleteComment(${comment.id}, ${eventId}, this.closest('.event-card'))" class="text-red-400 hover:text-red-600 text-xs ml-auto self-start"><i class="fas fa-trash-alt"></i></button>`;
                        }

                        commentDiv.innerHTML = `
                            <div class="flex justify-between items-start">
                                <p><strong class="commenter-name">${comment.commenter_name || 'مجهول'}</strong> <span class="text-xs text-gray-500">(${comment.commenter_email || 'لا يوجد بريد'})</span></p>
                                ${deleteButtonHtml}
                            </div>
                            <p class="text-gray-300 text-sm">${comment.comment_text.replace(/\n/g, '<br>')}</p>
                            <p class="comment-date">${commentDate}</p>
                        `;
                        commentsListElement.appendChild(commentDiv);
                    });
                }
            } catch (error) {
                console.error(`Error loading comments for event ${eventId}:`, error);
                commentsListElement.innerHTML = `<p class="text-red-400 text-sm">خطأ في تحميل التعليقات.</p>`;
                noCommentsYetElement.style.display = 'none';
            }
        }
        window.loadCommentsForEvent = loadCommentsForEvent;

        window.saveNewComment = async function(eventId, eventCardElement) {
            if (!window.supabaseClient) {
                showStaticModal("خطأ", "Supabase client غير مهيأ.");
                return;
            }

            const nameInput = eventCardElement.querySelector(`.comment-name-input-${eventId}`);
            const emailInputEl = eventCardElement.querySelector(`.comment-email-input-${eventId}`);
            const textInput = eventCardElement.querySelector(`.comment-text-input-${eventId}`);
            const statusMessage = eventCardElement.querySelector(`.comment-status-message-${eventId}`);

            const commentText = textInput.value.trim();
            let commenterName = nameInput.value.trim();
            let commenterEmail = emailInputEl.value.trim();
            let userId = null;

            if (window.currentUser && window.currentUser.id) {
                userId = window.currentUser.id;
                commenterName = window.currentUser.full_name_profile || window.currentUser.email.split('@')[0];
                commenterEmail = window.currentUser.email;
                nameInput.style.display = 'none';
                emailInputEl.style.display = 'none';
            } else {
                nameInput.style.display = 'block';
                emailInputEl.style.display = 'block';
                if (!commenterName || !commenterEmail) {
                    statusMessage.textContent = 'الرجاء إدخال الاسم والبريد الإلكتروني.';
                    statusMessage.className = 'comment-status-message text-xs mt-1 text-red-400';
                    statusMessage.style.display = 'block';
                    setTimeout(() => statusMessage.style.display = 'none', 3000);
                    return;
                }
            }

            if (!commentText) {
                statusMessage.textContent = 'الرجاء كتابة نص التعليق.';
                statusMessage.className = 'comment-status-message text-xs mt-1 text-red-400';
                statusMessage.style.display = 'block';
                setTimeout(() => statusMessage.style.display = 'none', 3000);
                return;
            }

            const commentData = {
                event_id: eventId,
                user_id: userId, 
                commenter_name: commenterName,
                commenter_email: commenterEmail,
                comment_text: commentText
            };

            console.log("Attempting to save comment:", commentData);

            try {
                const { error } = await window.supabaseClient
                    .from('event_comments')
                    .insert([commentData]);

                if (error) throw error;

                statusMessage.textContent = 'تم إرسال التعليق بنجاح!';
                statusMessage.className = 'comment-status-message text-xs mt-1 text-green-400';
                statusMessage.style.display = 'block';
                textInput.value = '';
                if (!window.currentUser) { 
                    nameInput.value = '';
                    emailInputEl.value = '';
                }
                setTimeout(() => statusMessage.style.display = 'none', 3000);
                
                if (typeof window.loadEvents === 'function') {
                    window.loadEvents(); // Reload all events to refresh comments
                }

            } catch (error) {
                console.error('Error saving comment:', error);
                statusMessage.textContent = `فشل إرسال التعليق: ${error.message}`;
                statusMessage.className = 'comment-status-message text-xs mt-1 text-red-400';
                statusMessage.style.display = 'block';
                setTimeout(() => statusMessage.style.display = 'none', 5000);
            }
        }
        window.saveNewComment = saveNewComment;

        window.deleteComment = async function(commentId, eventId, eventCardElement) {
            if (!window.currentUser || !window.supabaseClient) {
                showStaticModal("خطأ", "يجب تسجيل الدخول لحذف التعليقات.");
                return;
            }
            
            const confirmed = await new Promise(resolve => {
                window.showStaticModal("تأكيد الحذف", "هل أنت متأكد أنك تريد حذف هذا التعليق؟<br><br><div class='flex justify-center space-x-3 space-x-reverse'><button id='confirmDeleteCommentBtn' class='btn btn-danger'>نعم، احذف</button><button id='cancelDeleteCommentBtn' class='btn btn-secondary'>إلغاء</button></div>");
                document.getElementById('confirmDeleteCommentBtn').onclick = () => { window.closeModal('infoModal'); resolve(true); };
                document.getElementById('cancelDeleteCommentBtn').onclick = () => { window.closeModal('infoModal'); resolve(false); };
            });
            if (!confirmed) return;

            try {
                const { error } = await window.supabaseClient
                    .from('event_comments')
                    .delete()
                    .match({ id: commentId, user_id: window.currentUser.id }); 

                if (error) throw error;

                showStaticModal("نجاح", "تم حذف التعليق.");
                
                if (typeof window.loadEvents === 'function') { // Reload events to refresh comments
                    window.loadEvents();
                }

            } catch (error) {
                console.error('Error deleting comment:', error);
                showStaticModal("خطأ", `فشل حذف التعليق: ${error.message}`);
            }
        }
        window.deleteComment = deleteComment;

        // --- Reaction Functions ---
        const reactionsTable = 'event_reactions';
        const reactionTypes = ['like', 'love', 'laugh', 'wow', 'sad', 'angry'];
        const reactionEmojis = {
            like: '👍', love: '❤️', laugh: '😂', wow: '😮', sad: '😢', angry: '😠'
        };

        async function loadReactionsForEvent(eventId, eventCardElement) {
            if (!window.supabaseClient || !eventCardElement) {
                 console.error(`loadReactionsForEvent: Missing Supabase client or eventCardElement for event ID ${eventId}.`);
                 return;
            }
            console.log(`Loading reactions for event ID: ${eventId}`);

            try {
                // 1. Get all reactions for the event to calculate counts
                const { data: allReactions, error: reactionsError } = await window.supabaseClient
                    .from(reactionsTable)
                    .select('reaction_type, user_id')
                    .eq('event_id', eventId);

                if (reactionsError) throw reactionsError;

                // Initialize counts
                const reactionCounts = {};
                reactionTypes.forEach(type => reactionCounts[type] = 0);

                // Calculate counts
                if (allReactions) {
                    allReactions.forEach(reaction => {
                        if (reactionCounts.hasOwnProperty(reaction.reaction_type)) {
                            reactionCounts[reaction.reaction_type]++;
                        }
                    });
                }

                // Update counts on buttons
                reactionTypes.forEach(type => {
                    const countEl = eventCardElement.querySelector(`.reaction-count-${eventId}-${type}`);
                    if (countEl) {
                        countEl.textContent = reactionCounts[type] || '0';
                    } else {
                        // console.warn(`Count element .reaction-count-${eventId}-${type} not found.`);
                    }
                    const btnEl = eventCardElement.querySelector(`button[data-reaction-type="${type}"]`);
                    if (btnEl) {
                        btnEl.classList.remove('active'); // Reset active state
                    } else {
                         // console.warn(`Button element for reaction type ${type} not found for event ${eventId}.`);
                    }
                });

                // 2. Check if current user has reacted and highlight their reaction
                if (window.currentUser && window.currentUser.id) {
                    const userSpecificReaction = allReactions.find(r => r.user_id === window.currentUser.id);
                    if (userSpecificReaction) {
                        const activeBtn = eventCardElement.querySelector(`button[data-reaction-type="${userSpecificReaction.reaction_type}"]`);
                        if (activeBtn) {
                            activeBtn.classList.add('active');
                        }
                    }
                }
            } catch (error) {
                console.error(`Error loading reactions for event ${eventId}:`, error);
            }
        }
        window.loadReactionsForEvent = loadReactionsForEvent;
        
        window.handleReaction = async function(eventId, reactionType, buttonElement) {
            if (!window.currentUser) {
                showStaticModal("مطلوب تسجيل الدخول", "يجب تسجيل الدخول للتفاعل مع المنشورات.");
                showAuthModal('login');
                return;
            }
            if (!window.supabaseClient) {
                console.error("Supabase client not available for handling reaction.");
                return;
            }

            const userId = window.currentUser.id;
            const eventCardElement = buttonElement.closest('.event-card');

            try {
                const { data: existingReaction, error: fetchError } = await window.supabaseClient
                    .from(reactionsTable)
                    .select('*')
                    .eq('event_id', eventId)
                    .eq('user_id', userId)
                    .single();

                if (fetchError && fetchError.code !== 'PGRST116') { 
                    throw fetchError;
                }

                if (existingReaction) {
                    if (existingReaction.reaction_type === reactionType) {
                        const { error: deleteError } = await window.supabaseClient
                            .from(reactionsTable)
                            .delete()
                            .match({ event_id: eventId, user_id: userId });
                        if (deleteError) throw deleteError;
                    } else {
                        const { error: updateError } = await window.supabaseClient
                            .from(reactionsTable)
                            .update({ reaction_type: reactionType, created_at: new Date().toISOString() })
                            .match({ event_id: eventId, user_id: userId });
                        if (updateError) throw updateError;
                    }
                } else {
                    const { error: insertError } = await window.supabaseClient
                        .from(reactionsTable)
                        .insert({
                            event_id: eventId,
                            user_id: userId,
                            reaction_type: reactionType
                        });
                    if (insertError) throw insertError;
                }
                loadReactionsForEvent(eventId, eventCardElement);

            } catch (error) {
                console.error("Error handling reaction:", error);
                showStaticModal("خطأ", `فشل تسجيل التفاعل: ${error.message}`);
            }
        }
        window.handleReaction = handleReaction;


        // --- دوال Gemini API (تم تعطيلها أو إزالتها) ---
        window.showModalForApi = function(title, fallbackText = "هذه الميزة تستخدم API خارجي وهي غير متاحة حاليًا.") { 
            if (!generalInfoModal || !generalInfoModalTitle || !generalInfoModalText || !generalInfoModalLoading) { console.error("Modal elements not found for showModalForApi"); return;}
            generalInfoModalTitle.textContent = title; 
            generalInfoModalText.innerHTML = fallbackText.replace(/\n/g, '<br>');
            generalInfoModalLoading.style.display = "none"; 
            generalInfoModalText.style.display = "block"; 
            generalInfoModal.style.display = "block";
         };
        
        window.generateAIIdeas = async function() { 
            window.showModalForApi("✨ أفكار للمشروع", "ميزة اقتراح الأفكار باستخدام الذكاء الاصطناعي غير متاحة حاليًا. يمكنك تصفح الأفكار الموجودة أو إضافة فكرتك الخاصة!");
         };
        window.generateDetailedProjectDescription = async function() { 
            window.showModalForApi("✨ وصف تقني مفصل للمشروع", "ميزة إنشاء وصف تقني مفصل باستخدام الذكاء الاصطناعي غير متاحة حاليًا. يرجى مراجعة قسم 'نبذة عن المشروع'.");
         };
        window.suggestAdditionalTechnologies = async function() { 
            window.showModalForApi("✨ اقتراح تقنيات إضافية", "ميزة اقتراح تقنيات إضافية باستخدام الذكاء الاصطناعي غير متاحة حاليًا.");
         };
        window.suggestTasksForVacantRole = async function(roleName) { 
            window.showModalForApi(`✨ مهام مقترحة لـ ${roleName}`, `ميزة اقتراح المهام باستخدام الذكاء الاصطناعي غير متاحة حاليًا لدور "${roleName}".`);
         };
        
        // --- Hero Canvas Animation ---
        const heroCanvas = document.getElementById('heroCanvas');
        if (heroCanvas) {
            const ctx = heroCanvas.getContext('2d');
            let particlesArray;

            function resizeCanvas() {
                heroCanvas.width = window.innerWidth; // Use window innerWidth/Height for fixed canvas
                heroCanvas.height = window.innerHeight;
            }
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            class Particle {
                constructor(x, y, directionX, directionY, size, color) {
                    this.x = x;
                    this.y = y;
                    this.directionX = directionX;
                    this.directionY = directionY;
                    this.size = size;
                    this.color = color;
                }
                draw() {
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2, false);
                    ctx.fillStyle = this.color;
                    ctx.fill();
                }
                update() {
                    if (this.x + this.size > heroCanvas.width || this.x - this.size < 0) {
                        this.directionX = -this.directionX;
                    }
                    if (this.y + this.size > heroCanvas.height || this.y - this.size < 0) {
                        this.directionY = -this.directionY;
                    }
                    this.x += this.directionX;
                    this.y += this.directionY;
                    this.draw();
                }
            }

            function initElectrons() {
                particlesArray = [];
                let numberOfParticles = (heroCanvas.height * heroCanvas.width) / 5000; 
                if (numberOfParticles > 200) numberOfParticles = 200; 

                for (let i = 0; i < numberOfParticles; i++) {
                    let size = (Math.random() * 2.5) + 1.5; 
                    let x = Math.random() * heroCanvas.width;
                    let y = Math.random() * heroCanvas.height;
                    let directionX = (Math.random() * 1) - 0.5; 
                    let directionY = (Math.random() * 1) - 0.5; 
                    let color = `rgba(0, 230, 255, ${Math.random() * 0.6 + 0.4})`; 
                    particlesArray.push(new Particle(x, y, directionX, directionY, size, color));
                }
            }

            function animateElectrons() {
                requestAnimationFrame(animateElectrons);
                ctx.clearRect(0, 0, heroCanvas.width, heroCanvas.height);
                for (let i = 0; i < particlesArray.length; i++) {
                    particlesArray[i].update();
                }
            }

            window.addEventListener('resize', () => {
                resizeCanvas();
                initElectrons();
            });
            initElectrons();
            animateElectrons();
        }


        // استدعاء عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', () => {
            checkInitialSession(); 
        });

    </script>
</body>
</html>
